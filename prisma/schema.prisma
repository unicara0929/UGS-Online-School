generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                      String                   @id @default(cuid())
  email                   String                   @unique
  name                    String
  role                    UserRole                 @default(MEMBER)
  referralCode            String?                  @unique
  bankAccount             Json?
  // プロフィール拡張フィールド
  phone                   String?
  address                 String?
  bio                     String?
  attribute               String?
  gender                  String?
  birthDate               DateTime?
  prefecture              String?
  profileImageUrl         String?
  notificationPreferences Json?
  lastLoginAt             DateTime?
  createdAt               DateTime                 @default(now())
  updatedAt               DateTime                 @updatedAt
  compensations           Compensation[]
  courseProgress          CourseProgress[]
  events                  EventRegistration[]
  subscriptions           Subscription[]
  fpPromotionApplications FPPromotionApplication[]
  referralsAsReferrer     Referral[]               @relation("Referrer")
  referralsAsReferred     Referral[]               @relation("Referred")
  contracts               Contract[]
  notifications           Notification[]
  promotionApplications   PromotionApplication[]
  reviewedPromotions      PromotionApplication[]   @relation("PromotionReviewer")
  lpMeetingsAsMember      LPMeeting[]              @relation("LPMeetingMember")
  lpMeetingsAsFP          LPMeeting[]              @relation("LPMeetingFP")
  lpMeetingsAssigned      LPMeeting[]              @relation("LPMeetingAssigner")
  basicTestResults        BasicTestResult[]
  surveySubmissions       SurveySubmission[]
  cancelRequests          CancelRequest[]

  @@map("users")
}

model PendingUser {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("pending_users")
}

model Subscription {
  id                   String             @id @default(cuid())
  userId               String
  stripeCustomerId     String?            @unique
  stripeSubscriptionId String?            @unique
  status               SubscriptionStatus @default(ACTIVE)
  currentPeriodEnd     DateTime?
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt
  user                 User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("subscriptions")
}

model Course {
  id          String           @id @default(cuid())
  title       String
  description String?
  category    CourseCategory
  level       CourseLevel
  isLocked    Boolean          @default(false)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  progress    CourseProgress[]
  lessons     Lesson[]

  @@map("courses")
}

model Lesson {
  id          String           @id @default(cuid())
  courseId    String
  title       String
  description String?
  duration    Int
  order       Int
  videoUrl    String?
  pdfUrl      String?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  progress    CourseProgress[]
  course      Course           @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@map("lessons")
}

model CourseProgress {
  id          String    @id @default(cuid())
  userId      String
  courseId    String
  lessonId    String?
  isCompleted Boolean   @default(false)
  completedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  course      Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lesson      Lesson?   @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId, lessonId])
  @@map("course_progress")
}

model Event {
  id              String              @id @default(cuid())
  title           String
  description     String?
  date            DateTime
  time            String?
  type            EventType           @default(OPTIONAL)
  isOnline        Boolean             @default(true)
  location        String?
  maxParticipants Int?
  status          EventStatus         @default(UPCOMING)
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  registrations   EventRegistration[]

  @@map("events")
}

model EventRegistration {
  id        String   @id @default(cuid())
  userId    String
  eventId   String
  createdAt DateTime @default(now())
  event     Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, eventId])
  @@map("event_registrations")
}

model Compensation {
  id        String             @id @default(cuid())
  userId    String
  month     String
  amount    Int
  breakdown Json
  status    CompensationStatus @default(PENDING)
  createdAt DateTime           @default(now())
  updatedAt DateTime           @updatedAt
  user      User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, month])
  @@map("compensations")
}

enum UserRole {
  MEMBER
  FP
  MANAGER
  ADMIN
}

enum EventType {
  REQUIRED
  OPTIONAL
  MANAGER_ONLY
}

enum EventStatus {
  UPCOMING
  COMPLETED
  CANCELLED
}

enum SubscriptionStatus {
  ACTIVE
  CANCELED
  PAST_DUE
  UNPAID
}

enum CourseCategory {
  BASIC
  ADVANCED
  PRACTICAL
}

enum CourseLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
}

enum CompensationStatus {
  PENDING
  CONFIRMED
  PAID
}

enum FPPromotionApplicationStatus {
  PENDING
  APPROVED
  REJECTED
  COMPLETED
}

enum ReferralType {
  MEMBER
  FP
}

enum ReferralStatus {
  PENDING
  APPROVED
  REJECTED
  REWARDED
}

enum ContractType {
  INSURANCE
  OTHER
}

enum ContractStatus {
  ACTIVE
  CANCELLED
  EXPIRED
}

enum NotificationType {
  PROMOTION_ELIGIBLE
  PROMOTION_APPROVED
  PROMOTION_REJECTED
  COMPENSATION_READY
  COMPENSATION_PAID
  EVENT_REMINDER
  EVENT_REQUIRED
  REFERRAL_REWARDED
  CONTRACT_ACHIEVED
  ACTION_REQUIRED
  LP_MEETING_REQUESTED
  LP_MEETING_SCHEDULED
  LP_MEETING_COMPLETED
  LP_MEETING_REMINDER
}

enum NotificationPriority {
  CRITICAL
  INFO
  SUCCESS
}

enum PromotionStatus {
  PENDING
  APPROVED
  REJECTED
}

model FPPromotionApplication {
  id                 String                       @id @default(cuid())
  userId             String
  status             FPPromotionApplicationStatus @default(PENDING)
  lpMeetingCompleted Boolean                      @default(false)
  basicTestCompleted Boolean                      @default(false)
  surveyCompleted    Boolean                      @default(false)
  idDocumentUrl      String?
  appliedAt          DateTime                     @default(now())
  approvedAt         DateTime?
  completedAt        DateTime?
  createdAt          DateTime                     @default(now())
  updatedAt          DateTime                     @updatedAt
  user               User                         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId])
  @@map("fp_promotion_applications")
}

model Referral {
  id           String         @id @default(cuid())
  referrerId   String
  referredId   String
  referralType ReferralType
  status       ReferralStatus @default(PENDING)
  rewardAmount Int?
  rewardPaidAt DateTime?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  referrer     User           @relation("Referrer", fields: [referrerId], references: [id], onDelete: Cascade)
  referred     User           @relation("Referred", fields: [referredId], references: [id], onDelete: Cascade)

  @@unique([referrerId, referredId])
  @@map("referrals")
}

model Contract {
  id             String         @id @default(cuid())
  userId         String
  contractNumber String         @unique
  contractType   ContractType
  status         ContractStatus @default(ACTIVE)
  signedAt       DateTime
  amount         Int?
  rewardAmount   Int?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  user           User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("contracts")
}

model Notification {
  id        String               @id @default(cuid())
  userId    String
  type      NotificationType
  priority  NotificationPriority @default(INFO)
  title     String
  message   String
  actionUrl String?
  isRead    Boolean              @default(false)
  readAt    DateTime?
  createdAt DateTime             @default(now())
  user      User                 @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@index([userId, createdAt])
  @@map("notifications")
}

model PromotionApplication {
  id          String          @id @default(cuid())
  userId      String
  targetRole  UserRole
  status      PromotionStatus @default(PENDING)
  appliedAt   DateTime        @default(now())
  reviewedAt  DateTime?
  reviewedBy  String?
  reviewNotes String?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  user        User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  reviewer    User?           @relation("PromotionReviewer", fields: [reviewedBy], references: [id], onDelete: SetNull)

  @@unique([userId, targetRole])
  @@map("promotion_applications")
}

model LPMeeting {
  id              String           @id @default(cuid())
  memberId        String
  fpId            String?
  status          LPMeetingStatus  @default(REQUESTED)
  preferredDates  Json // 希望日時（5つ、DateTime[]）
  scheduledAt     DateTime?
  completedAt     DateTime?
  cancelledAt     DateTime?
  meetingUrl      String?
  meetingPlatform MeetingPlatform?
  notes           String?
  memberNotes     String?
  assignedBy      String?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  member   User  @relation("LPMeetingMember", fields: [memberId], references: [id], onDelete: Cascade)
  fp       User? @relation("LPMeetingFP", fields: [fpId], references: [id], onDelete: SetNull)
  assigner User? @relation("LPMeetingAssigner", fields: [assignedBy], references: [id], onDelete: SetNull)

  @@unique([memberId])
  @@index([fpId, status])
  @@index([memberId, status])
  @@index([status])
  @@map("lp_meetings")
}

enum LPMeetingStatus {
  REQUESTED
  SCHEDULED
  COMPLETED
  CANCELLED
  NO_SHOW
}

enum MeetingPlatform {
  ZOOM
  GOOGLE_MEET
  TEAMS
  OTHER
}

model BasicTest {
  id           String            @id @default(cuid())
  title        String
  questions    Json // 問題の配列
  passingScore Int               @default(70) // 合格点（%）
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
  results      BasicTestResult[]

  @@map("basic_tests")
}

model BasicTestResult {
  id          String    @id @default(cuid())
  userId      String
  testId      String
  score       Int // 得点（%）
  answers     Json // 回答の配列
  isPassed    Boolean // 合格したかどうか
  completedAt DateTime  @default(now())
  createdAt   DateTime  @default(now())
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  test        BasicTest @relation(fields: [testId], references: [id], onDelete: Cascade)

  @@unique([userId, testId])
  @@map("basic_test_results")
}

model Survey {
  id          String             @id @default(cuid())
  title       String
  questions   Json // 設問の配列
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  submissions SurveySubmission[]

  @@map("surveys")
}

model SurveySubmission {
  id          String   @id @default(cuid())
  userId      String
  surveyId    String
  answers     Json // 回答の配列
  submittedAt DateTime @default(now())
  createdAt   DateTime @default(now())
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  survey      Survey   @relation(fields: [surveyId], references: [id], onDelete: Cascade)

  @@unique([userId, surveyId])
  @@map("survey_submissions")
}

model CancelRequest {
  id                 String              @id @default(cuid())
  userId             String
  name               String
  email              String
  reason             String
  otherReason        String?
  continuationOption String
  status             CancelRequestStatus @default(PENDING)
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  user               User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("cancel_requests")
}

enum CancelRequestStatus {
  PENDING
  APPROVED
  REJECTED
  COMPLETED
}
