generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                      String                   @id @default(cuid())
  email                   String                   @unique
  name                    String
  role                    UserRole                 @default(MEMBER)
  memberId                String                   @unique // 会員番号（例: UGS0000001）
  referralCode            String?                  @unique
  bankAccount             Json?
  // プロフィール拡張フィールド
  phone                   String?
  lineId                  String?                  // LINE ID（マネージャー連絡用）
  address                 String?
  bio                     String?
  attribute               String?
  gender                  String?
  birthDate               DateTime?
  prefecture              String?
  profileImageUrl         String?
  mbtiType                String?                  // MBTIタイプ（16タイプ）
  discType                String?                  // DISCタイプ（12タイプ）
  notificationPreferences Json?
  lastLoginAt             DateTime?
  // FPエイド オンボーディング関連
  fpPromotionApproved     Boolean                  @default(false) // FPエイド昇格申請承認済みフラグ（3ステップ完了でFPに昇格）
  managerContactConfirmedAt DateTime?              // マネージャー連絡先確認完了日時（FP昇格後に入力）
  fpOnboardingCompleted   Boolean                  @default(true) // FPエイド向け動画ガイダンス完了フラグ（既存ユーザーはtrue）
  fpOnboardingCompletedAt DateTime?                // FPエイド向け動画ガイダンス完了日時
  complianceTestPassed    Boolean                  @default(true) // コンプライアンステスト合格フラグ（既存ユーザーはtrue）
  complianceTestPassedAt  DateTime?                // コンプライアンステスト合格日時
  // マネージャー紐づけ（FPエイドの担当マネージャー）
  managerId               String?                  // 担当マネージャーのID
  manager                 User?                    @relation("ManagerTeam", fields: [managerId], references: [id], onDelete: SetNull)
  teamMembers             User[]                   @relation("ManagerTeam") // このマネージャーが担当するFPエイド
  // 業務委託契約書
  contractCompleted       Boolean                  @default(false) // 業務委託契約書完了フラグ
  contractCompletedAt     DateTime?                // 業務委託契約書完了日時
  contractCompletedBy     String?                  // 契約完了をマークした管理者ID
  // 会員管理フィールド
  membershipStatus        MembershipStatus         @default(ACTIVE) // 会員ステータス
  membershipStatusReason  String?                  // ステータス変更理由
  membershipStatusChangedAt DateTime?              // ステータス変更日時
  membershipStatusChangedBy String?                // ステータス変更者（管理者ID）
  canceledAt              DateTime?                // 退会日時
  cancellationReason      String?                  // 退会理由
  delinquentSince         DateTime?                // 滞納開始日
  reactivatedAt           DateTime?                // 再開日時
  createdAt               DateTime                 @default(now())
  updatedAt               DateTime                 @updatedAt
  compensations           Compensation[]
  courseProgress          CourseProgress[]
  events                  EventRegistration[]
  subscriptions           Subscription[]
  fpPromotionApplications FPPromotionApplication[]
  referralsAsReferrer     Referral[]               @relation("Referrer")
  referralsAsReferred     Referral[]               @relation("Referred")
  contracts               Contract[]
  notifications           Notification[]
  promotionApplications   PromotionApplication[]
  reviewedPromotions      PromotionApplication[]   @relation("PromotionReviewer")
  lpMeetingsAsMember      LPMeeting[]              @relation("LPMeetingMember")
  lpMeetingsAsFP          LPMeeting[]              @relation("LPMeetingFP")
  lpMeetingsAssigned      LPMeeting[]              @relation("LPMeetingAssigner")
  basicTestResults        BasicTestResult[]
  surveySubmissions       SurveySubmission[]
  cancelRequests          CancelRequest[]
  membershipStatusHistory MembershipStatusHistory[]
  emailLogs               EmailLog[]
  compensationBankAccount BankAccount? @relation("compensationBankAccount") // 報酬受け取り口座（FP/MGR向け）
  roleChangeHistory       RoleChangeHistory[]
  contactSubmissions      ContactSubmission[] // お問い合わせ
  businessCardOrders      BusinessCardOrder[] // 名刺注文
  consultations           Consultation[] // 個別相談
  handledConsultations    Consultation[] @relation("ConsultationHandler") // 対応した個別相談
  // 新着通知機能
  categoryViews           UserCategoryView[]
  contentViews            UserContentView[]
  notificationReads       UserNotificationRead[] // システム通知の既読管理
  // 事前アンケート
  preInterviewResponses   PreInterviewResponse[] @relation("PreInterviewRespondent")
  // コンプライアンステスト
  complianceTestAttempts  ComplianceTestAttempt[]
  // 全体MTG免除申請
  mtgExemptions           MtgExemption[]

  @@map("users")
}

model PendingUser {
  id                String   @id @default(cuid())
  email             String   @unique
  name              String
  password          String   // ハッシュ化されたパスワード（一時保存）
  plainPassword     String?  // プレーンテキストパスワード（Supabaseユーザー作成用、一時保存）
  referralCode      String?  // 紹介コード（URLから取得）
  emailVerified     Boolean  @default(false) // メール認証済みフラグ
  verificationToken String?  @unique // メール認証トークン
  tokenExpiresAt    DateTime? // トークン有効期限
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@map("pending_users")
}

model Subscription {
  id                   String             @id @default(cuid())
  userId               String
  stripeCustomerId     String?            @unique
  stripeSubscriptionId String?            @unique
  status               SubscriptionStatus @default(ACTIVE)
  currentPeriodEnd     DateTime?
  cancelRequestedAt    DateTime?          // 退会申請日時
  cancelAt             DateTime?          // キャンセル予定日（6ヶ月契約満了日）
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt
  user                 User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("subscriptions")
}

model Course {
  id          String           @id @default(cuid())
  title       String
  description String?
  category    CourseCategory
  level       CourseLevel
  isLocked    Boolean          @default(false)
  isPublished Boolean          @default(true) // 公開/非公開管理
  order       Int              @default(0) // コース間の並び順
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  progress    CourseProgress[]
  lessons     Lesson[]

  @@map("courses")
}

model Lesson {
  id          String           @id @default(cuid())
  courseId    String
  title       String
  description String?
  duration    Int
  order       Int
  videoUrl    String?
  pdfUrl      String?
  isPublished Boolean          @default(true) // 公開/非公開管理
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  progress    CourseProgress[]
  course      Course           @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@map("lessons")
}

model CourseProgress {
  id             String    @id @default(cuid())
  userId         String
  courseId       String
  lessonId       String?
  isCompleted    Boolean   @default(false)
  completedAt    DateTime?
  currentTime    Int?      // 動画視聴位置（秒）
  videoDuration  Int?      // 動画の長さ（秒）
  lastWatchedAt  DateTime? // 最後に視聴した日時
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  course         Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lesson         Lesson?   @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId, lessonId])
  @@map("course_progress")
}

model Event {
  id              String              @id @default(cuid())
  title           String
  description     String?
  date            DateTime
  time            String?
  type            EventType           @default(OPTIONAL) // 後方互換性のため残す（非推奨）
  targetRoles     EventTargetRole[]   // 対象ロール（複数選択可能）: UGS会員 / FPエイド / マネージャー / 全員
  attendanceType  EventAttendanceType @default(OPTIONAL) // 参加設定: 必須 / 任意
  venueType       EventVenueType      @default(ONLINE) // 開催形式: オンライン / オフライン / ハイブリッド
  location        String?
  maxParticipants Int?
  status          EventStatus         @default(UPCOMING)
  // サムネイル画像
  thumbnailUrl    String?             // サムネイル画像URL（Supabase Storage）
  // 有料イベント関連
  isPaid          Boolean             @default(false) // 有料イベントかどうか
  price           Int?                // 価格（円）- isPaid=trueの場合は必須
  stripePriceId   String?             // Stripe Price ID
  // 全体MTG・出席確認関連
  attendanceCode  String?             // 参加コード（アルファベット）- オフライン/ライブ参加者用
  vimeoUrl        String?             // Vimeo録画URL - 後日視聴用
  surveyUrl       String?             // アンケートURL - 録画視聴者用
  attendanceDeadline DateTime?        // 出席完了期限（イベント終了後24時間など）
  // 定期開催イベント関連
  isRecurring     Boolean             @default(false) // 定期開催イベントかどうか
  recurrencePattern String?           // 繰り返しパターン（例: "monthly-first-sunday"）
  // 過去イベント記録用フィールド
  summary           String?           @db.Text // 実施内容の概要
  photos            String[]          // 当日の写真URL（複数）
  materialsUrl      String?           // セミナー資料リンク（PDF等）
  actualParticipants Int?             // 実参加人数
  actualLocation    String?           // 最終的な会場情報
  adminNotes        String?           @db.Text // 管理者用メモ（参加者の反応、改善点など）
  isArchiveOnly     Boolean           @default(false) // 記録専用イベントかどうか（募集なし）
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  registrations   EventRegistration[]
  emailCampaigns  EmailCampaign[]
  mtgExemptions   MtgExemption[]      // 免除申請

  @@map("events")
}

model EventRegistration {
  id                     String              @id @default(cuid())
  userId                 String
  eventId                String
  // 支払い関連
  paymentStatus          EventPaymentStatus  @default(PENDING) // 支払いステータス
  stripePaymentIntentId  String?             // Stripe PaymentIntent ID
  stripeSessionId        String?             // Stripe Checkout Session ID
  paidAmount             Int?                // 支払い金額（円）
  paidAt                 DateTime?           // 支払い完了日時
  // キャンセル・返金関連
  canceledAt             DateTime?           // キャンセル日時
  cancelReason           String?             // キャンセル理由
  refundStatus           EventRefundStatus   @default(NONE) // 返金ステータス
  refundedAt             DateTime?           // 返金完了日時
  // 出席確認関連
  attendanceMethod       AttendanceMethod?   // 出席方法: コード入力 or 録画視聴+アンケート
  attendanceCompletedAt  DateTime?           // 出席完了日時
  videoWatched           Boolean             @default(false) // 録画視聴済みかどうか
  surveyCompleted        Boolean             @default(false) // アンケート回答済みかどうか
  // 全体MTG参加意思（事前回答）
  participationIntent    ParticipationIntent @default(UNDECIDED) // 参加意思
  participationIntentAt  DateTime?           // 参加意思回答日時
  createdAt              DateTime            @default(now())
  updatedAt              DateTime            @default(now()) @updatedAt
  event                  Event               @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user                   User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, eventId])
  @@map("event_registrations")
}

model Compensation {
  id            String             @id @default(cuid())
  userId        String
  month         String
  amount        Int
  breakdown     Json
  contractCount Int                @default(0) // その月の契約件数
  earnedAsRole  UserRole           @default(FP) // 報酬発生時のロール（FPエイド/マネージャー）
  status        CompensationStatus @default(PENDING)
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  user          User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, month])
  @@index([earnedAsRole])
  @@map("compensations")
}

enum UserRole {
  MEMBER
  FP
  MANAGER
  ADMIN
}

enum EventType {
  REQUIRED
  OPTIONAL
  MANAGER_ONLY
}

enum EventTargetRole {
  MEMBER    // UGS会員
  FP        // FPエイド
  MANAGER   // マネージャー
  ALL       // 全員
}

enum EventAttendanceType {
  REQUIRED  // 必須
  OPTIONAL  // 任意
}

enum EventVenueType {
  ONLINE    // オンラインのみ
  OFFLINE   // オフラインのみ
  HYBRID    // ハイブリッド（オンライン＋オフライン両方）
}

enum EventStatus {
  UPCOMING
  COMPLETED
  CANCELLED
}

enum AttendanceMethod {
  CODE          // 参加コード入力による出席
  VIDEO_SURVEY  // 録画視聴+アンケート回答による出席
}

// 全体MTGの参加意思
enum ParticipationIntent {
  UNDECIDED     // 未回答
  WILL_ATTEND   // 参加する
  WILL_NOT_ATTEND // 参加しない（動画視聴予定）
}

enum SubscriptionStatus {
  ACTIVE
  CANCELED
  PAST_DUE
  UNPAID
}

enum MembershipStatus {
  PENDING                // 仮登録（決済未完了）
  ACTIVE                 // 有効会員（通常の状態）
  PAST_DUE               // 支払い遅延（決済失敗、猶予期間中）
  DELINQUENT             // 長期滞納（猶予期間経過後も未払い）
  CANCELLATION_PENDING   // 退会予定（退会申請済み、期間終了待ち）
  CANCELED               // 退会済み（ユーザーによる退会申請）
  TERMINATED             // 強制解約（運営による強制解約）
  EXPIRED                // 期限切れ（仮登録の有効期限切れ）
}

enum CourseCategory {
  BASIC
  ADVANCED
  PRACTICAL
  STARTUP_GUIDE  // スタートアップガイド（UGS会員向け）
}

enum CourseLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
}

enum CompensationStatus {
  PENDING
  CONFIRMED
  PAID
}

enum FPPromotionApplicationStatus {
  PENDING
  APPROVED
  REJECTED
  COMPLETED
}

enum ReferralType {
  MEMBER
  FP
}

enum ReferralStatus {
  PENDING
  APPROVED
  REJECTED
  REWARDED
}

enum ContractType {
  INSURANCE     // 保険
  REAL_ESTATE   // 不動産
  RENTAL        // 賃貸
  SOLAR_BATTERY // 太陽光/蓄電池
  CAREER        // 転職
  HOUSING       // 住宅
  OTHER         // その他
}

enum ContractStatus {
  ACTIVE
  CANCELLED
  EXPIRED
}

enum NotificationType {
  PROMOTION_ELIGIBLE
  PROMOTION_APPROVED
  PROMOTION_REJECTED
  COMPENSATION_READY
  COMPENSATION_PAID
  EVENT_REMINDER
  EVENT_REQUIRED
  REFERRAL_REWARDED
  CONTRACT_ACHIEVED
  ACTION_REQUIRED
  LP_MEETING_REQUESTED
  LP_MEETING_SCHEDULED
  LP_MEETING_COMPLETED
  LP_MEETING_REMINDER
  CONSULTATION_SUBMITTED
  CONSULTATION_COMPLETED
  PRE_INTERVIEW_REQUESTED     // 事前アンケート回答依頼
  PRE_INTERVIEW_REMINDER      // 事前アンケートリマインダー
  PRE_INTERVIEW_COMPLETED     // 事前アンケート回答完了（FPへ通知）
}

enum NotificationPriority {
  CRITICAL
  INFO
  SUCCESS
}

enum PromotionStatus {
  PENDING
  APPROVED
  REJECTED
}

model FPPromotionApplication {
  id                    String                       @id @default(cuid())
  userId                String
  status                FPPromotionApplicationStatus @default(PENDING)
  lpMeetingCompleted    Boolean                      @default(false)
  basicTestCompleted    Boolean                      @default(false)
  surveyCompleted       Boolean                      @default(false)
  idDocumentUrl         String?
  idDocumentUploadedAt  DateTime? // 身分証アップロード日時
  contractAgreed        Boolean                      @default(false) // 業務委託契約書への同意
  contractAgreedAt      DateTime? // 契約書同意日時
  promotionEmailSent    Boolean                      @default(false) // 昇格通知メール送信済みフラグ
  promotionEmailSentAt  DateTime? // 昇格通知メール送信日時
  appliedAt             DateTime                     @default(now())
  approvedAt            DateTime?
  completedAt           DateTime?
  createdAt             DateTime                     @default(now())
  updatedAt             DateTime                     @updatedAt
  user                  User                         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId])
  @@map("fp_promotion_applications")
}

model Referral {
  id           String         @id @default(cuid())
  referrerId   String
  referredId   String
  referralType ReferralType
  status       ReferralStatus @default(PENDING)
  rewardAmount Int?
  rewardPaidAt DateTime?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  referrer     User           @relation("Referrer", fields: [referrerId], references: [id], onDelete: Cascade)
  referred     User           @relation("Referred", fields: [referredId], references: [id], onDelete: Cascade)

  @@unique([referrerId, referredId])
  @@map("referrals")
}

model Contract {
  id             String         @id @default(cuid())
  userId         String                              // FPエイドのユーザーID
  contractNumber String         @unique             // 契約番号
  productName    String?                            // 商品名
  contractType   ContractType                       // 契約種別（販売事業区分）
  status         ContractStatus @default(ACTIVE)    // 契約ステータス
  signedAt       DateTime                           // 契約日
  amount         Int?                               // 契約金額・保険料
  rewardAmount   Int?                               // 報酬額
  customerName   String?                            // 契約者名
  note           String?                            // メモ・備考
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  user           User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("contracts")
}

model Notification {
  id        String               @id @default(cuid())
  userId    String
  type      NotificationType
  priority  NotificationPriority @default(INFO)
  title     String
  message   String
  actionUrl String?
  isRead    Boolean              @default(false)
  readAt    DateTime?
  createdAt DateTime             @default(now())
  user      User                 @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@index([userId, createdAt])
  @@map("notifications")
}

model PromotionApplication {
  id              String          @id @default(cuid())
  userId          String
  targetRole      UserRole
  status          PromotionStatus @default(PENDING)
  appliedAt       DateTime        @default(now())
  approvedAt      DateTime?
  rejectedAt      DateTime?
  rejectionReason String?
  reviewedAt      DateTime?
  reviewedBy      String?
  reviewNotes     String?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  user            User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  reviewer        User?           @relation("PromotionReviewer", fields: [reviewedBy], references: [id], onDelete: SetNull)

  @@unique([userId, targetRole])
  @@map("promotion_applications")
}

model LPMeeting {
  id              String           @id @default(cuid())
  memberId        String
  fpId            String?
  counselorName   String? // 固定メンバーの名前
  counselorEmail  String? // 固定メンバーのメールアドレス
  status          LPMeetingStatus  @default(REQUESTED)
  preferredDates  Json // 希望日時（5つ、DateTime[]）
  meetingLocation MeetingLocation? // 面談場所
  scheduledAt     DateTime?
  completedAt     DateTime?
  cancelledAt     DateTime?
  meetingUrl      String?
  meetingPlatform MeetingPlatform?
  notes           String?
  memberNotes     String?
  assignedBy      String?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  member   User  @relation("LPMeetingMember", fields: [memberId], references: [id], onDelete: Cascade)
  fp       User? @relation("LPMeetingFP", fields: [fpId], references: [id], onDelete: SetNull)
  assigner User? @relation("LPMeetingAssigner", fields: [assignedBy], references: [id], onDelete: SetNull)

  preInterviewResponse PreInterviewResponse?  // 事前アンケート回答

  // @@unique([memberId]) を削除し、再申請を可能に（キャンセル/ノーショー後に再申請できる）
  @@index([fpId, status])
  @@index([memberId, status])
  @@index([memberId])
  @@index([status])
  @@map("lp_meetings")
}

enum LPMeetingStatus {
  REQUESTED
  SCHEDULED
  COMPLETED
  CANCELLED
  NO_SHOW
}

enum MeetingPlatform {
  ZOOM
  GOOGLE_MEET
  TEAMS
  OTHER
}

enum MeetingLocation {
  OFFLINE    // オンライン（Zoom等）
  UGS_OFFICE // UGS本社（愛知県名古屋市）
}

model BasicTest {
  id           String            @id @default(cuid())
  title        String
  questions    Json // 問題の配列
  passingScore Int               @default(70) // 合格点（%）
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
  results      BasicTestResult[]

  @@map("basic_tests")
}

model BasicTestResult {
  id          String    @id @default(cuid())
  userId      String
  testId      String
  score       Int // 得点（%）
  answers     Json // 回答の配列
  isPassed    Boolean // 合格したかどうか
  completedAt DateTime  @default(now())
  createdAt   DateTime  @default(now())
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  test        BasicTest @relation(fields: [testId], references: [id], onDelete: Cascade)

  @@unique([userId, testId])
  @@map("basic_test_results")
}

model Survey {
  id          String             @id @default(cuid())
  title       String
  questions   Json // 設問の配列
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  submissions SurveySubmission[]

  @@map("surveys")
}

model SurveySubmission {
  id          String   @id @default(cuid())
  userId      String
  surveyId    String
  answers     Json // 回答の配列
  submittedAt DateTime @default(now())
  createdAt   DateTime @default(now())
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  survey      Survey   @relation(fields: [surveyId], references: [id], onDelete: Cascade)

  @@unique([userId, surveyId])
  @@map("survey_submissions")
}

model CancelRequest {
  id                 String              @id @default(cuid())
  userId             String
  name               String
  email              String
  reason             String
  otherReason        String?
  continuationOption String
  status             CancelRequestStatus @default(PENDING)
  contractEndDate    DateTime?           // 契約解除日（6ヶ月未満の場合に設定）
  isScheduled        Boolean             @default(false) // 解約予約かどうか
  adminNote          String?             // 管理者メモ
  processedAt        DateTime?           // 処理日時
  processedBy        String?             // 処理した管理者ID
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  user               User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("cancel_requests")
}

enum CancelRequestStatus {
  PENDING
  APPROVED
  REJECTED
  COMPLETED
}

enum EventPaymentStatus {
  PENDING   // 支払い待ち
  FREE      // 無料イベント
  PAID      // 支払い完了
  FAILED    // 支払い失敗
  REFUNDED  // 返金済み
}

enum EventRefundStatus {
  NONE        // 返金なし
  REQUESTED   // 返金リクエスト
  PROCESSING  // 返金処理中
  COMPLETED   // 返金完了
  FAILED      // 返金失敗
}

model Material {
  id             String                 @id @default(cuid())
  title          String
  description    String?
  fileUrl        String? // ファイルURL（Supabase Storageなど）
  fileName       String?
  fileSize       String? // 例: "2.5MB"
  fileType       String? // 例: "PDF", "DOCX"
  category       String? // 例: "マニュアル", "テンプレート"
  viewableRoles  MaterialViewableRole[] // 閲覧可能ロール（複数選択）
  createdAt      DateTime               @default(now())
  updatedAt      DateTime               @updatedAt

  @@map("materials")
}

enum MaterialViewableRole {
  ADMIN   // 管理者
  MANAGER // マネージャー
  FP      // FPエイド
  MEMBER  // UGS会員
}

// 会員ステータス変更履歴
model MembershipStatusHistory {
  id            String           @id @default(cuid())
  userId        String
  user          User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  fromStatus    MembershipStatus // 変更前のステータス
  toStatus      MembershipStatus // 変更後のステータス
  reason        String?          // 変更理由
  changedBy     String?          // 変更者（管理者の場合はそのID、システムの場合は"SYSTEM"）
  changedByName String?          // 変更者名（表示用）
  createdAt     DateTime         @default(now())

  @@map("membership_status_history")
}

// ロール変更履歴（UGS会員→FPエイドなどの昇格記録）
model RoleChangeHistory {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  fromRole      UserRole // 変更前のロール
  toRole        UserRole // 変更後のロール
  reason        String?  // 変更理由（昇格申請承認、管理者による変更など）
  changedBy     String?  // 変更者（管理者ID、システムの場合は"SYSTEM"）
  changedByName String?  // 変更者名（表示用）
  createdAt     DateTime @default(now())

  @@index([userId])
  @@index([fromRole, toRole])
  @@index([createdAt])
  @@map("role_change_history")
}

// メール送信履歴（バッチ単位）
model EmailCampaign {
  id           String          @id @default(cuid())
  subject      String          // 件名
  body         String          @db.Text // 本文
  templateType String?         // テンプレート種別
  sourceType   EmailSourceType // 送信元: USER_MANAGEMENT | EVENT_MANAGEMENT
  eventId      String?         // イベントID（イベント経由の場合）
  totalCount   Int             // 送信対象人数
  successCount Int             @default(0) // 成功件数
  failedCount  Int             @default(0) // 失敗件数
  sentBy       String          // 送信者（管理者ID）
  sentAt       DateTime        @default(now())
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt

  event Event?     @relation(fields: [eventId], references: [id], onDelete: SetNull)
  logs  EmailLog[] // 個別配信ログ

  @@index([sentAt])
  @@index([sourceType])
  @@index([eventId])
  @@map("email_campaigns")
}

// 個別配信ログ（ユーザー単位）
model EmailLog {
  id           String      @id @default(cuid())
  campaignId   String      // キャンペーンID
  userId       String      // 宛先ユーザーID
  email        String      // 送信先メールアドレス
  status       EmailStatus // 配信ステータス
  errorMessage String?     // エラーメッセージ
  sentAt       DateTime    @default(now())
  createdAt    DateTime    @default(now())

  campaign EmailCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  user     User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([campaignId])
  @@index([status])
  @@map("email_logs")
}

enum EmailSourceType {
  USER_MANAGEMENT  // ユーザー管理画面から
  EVENT_MANAGEMENT // イベント管理画面から
}

enum EmailStatus {
  SENT    // 送信成功
  FAILED  // 送信失敗
  BOUNCED // バウンス
  INVALID // 無効なアドレス
}

// 報酬受け取り口座情報（FP/マネージャー向け）
model BankAccount {
  id              String         @id @default(cuid())
  userId          String         @unique
  // 通常の銀行情報
  bankName        String         // 金融機関名
  branchName      String?        // 支店名
  branchNumber    String?        // 支店番号（ゆうちょ以外）
  accountType     AccountType    // 口座種別（普通/当座/貯蓄）
  accountNumber   String         // 口座番号
  accountHolderName String       // 口座名義（カタカナ）
  // ゆうちょ銀行専用フィールド
  isYuchoBank     Boolean        @default(false) // ゆうちょ銀行フラグ
  yuchoSymbol     String?        // 記号（5桁）
  yuchoNumber     String?        // 番号（最大8桁）
  // 監査・履歴用
  lastModifiedBy  String?        // 最終更新者（管理者IDまたはnullで本人）
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  
  user            User           @relation("compensationBankAccount", fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@map("bank_accounts")
}

enum AccountType {
  NORMAL   // 普通預金
  CHECKING // 当座預金
  SAVINGS  // 貯蓄預金
}

// =====================
// FAQ・お問い合わせ機能
// =====================

// FAQカテゴリ
model FAQCategory {
  id          String    @id @default(cuid())
  name        String    // カテゴリ名（例: アカウントについて、料金・支払いについて）
  description String?   // カテゴリの説明
  order       Int       @default(0) // 表示順
  isActive    Boolean   @default(true) // 有効/無効
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  faqs        FAQ[]

  @@index([order])
  @@index([isActive])
  @@map("faq_categories")
}

// FAQ（よくある質問）
model FAQ {
  id          String      @id @default(cuid())
  categoryId  String
  question    String      // 質問タイトル
  answer      String      @db.Text // 回答本文
  order       Int         @default(0) // 表示順（カテゴリ内）
  isPublished Boolean     @default(true) // 公開/非公開
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  category    FAQCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@index([categoryId, order])
  @@index([isPublished])
  @@map("faqs")
}

// お問い合わせ種別
enum ContactType {
  ACCOUNT     // アカウントについて
  PAYMENT     // 支払い・請求について
  CONTENT     // コンテンツについて
  TECHNICAL   // 技術的な問題
  OTHER       // その他
}

// お問い合わせステータス
enum ContactStatus {
  PENDING     // 未対応
  IN_PROGRESS // 対応中
  RESOLVED    // 対応済み
  CLOSED      // クローズ
}

// お問い合わせ
model ContactSubmission {
  id            String        @id @default(cuid())
  userId        String
  name          String        // 送信者名
  email         String        // 送信者メールアドレス
  type          ContactType   // 問い合わせ種別
  subject       String?       // 件名（任意）
  message       String        @db.Text // 問い合わせ内容
  attachmentUrl String?       // 添付ファイルURL（任意）
  status        ContactStatus @default(PENDING) // ステータス
  adminNotes    String?       @db.Text // 管理者用メモ
  respondedBy   String?       // 対応者（管理者ID）
  respondedAt   DateTime?     // 対応完了日時
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([type])
  @@index([createdAt])
  @@map("contact_submissions")
}

// =====================
// 名刺注文機能
// =====================

// 名刺注文ステータス
enum BusinessCardOrderStatus {
  PENDING     // 支払い待ち
  PAID        // 支払い完了・受付中
  ORDERED     // 発注済み
  SHIPPED     // 発送済み
  COMPLETED   // 完了
  CANCELLED   // キャンセル
}

// 名刺受取方法
enum BusinessCardDeliveryMethod {
  PICKUP    // UGS本社での手渡し受け取り
  SHIPPING  // レターパック郵送
}

// 名刺注文決済ステータス
enum BusinessCardPaymentStatus {
  PENDING   // 支払い待ち
  PAID      // 支払い完了
  FAILED    // 支払い失敗
  REFUNDED  // 返金済み
}

// 名刺デザインテンプレート
model BusinessCardDesign {
  id              String    @id @default(cuid())
  name            String    // デザイン名（例: シンプル、写真あり、ロゴ強調）
  description     String?   // デザインの説明
  previewUrl      String?   // プレビュー画像URL（表面）
  previewUrlBack  String?   // プレビュー画像URL（裏面）
  isActive        Boolean   @default(true) // 有効/無効
  order           Int       @default(0) // 表示順
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  orders          BusinessCardOrder[]

  @@index([isActive, order])
  @@map("business_card_designs")
}

// 名刺注文
model BusinessCardOrder {
  id                String                      @id @default(cuid())
  userId            String
  designId          String
  // 名刺に印字する情報
  displayName       String                      // 表示名（名刺に印字する氏名）
  displayNameKana   String                      // 氏名フリガナ
  phoneNumber       String                      // 電話番号
  email             String                      // メールアドレス
  // 受取方法
  deliveryMethod    BusinessCardDeliveryMethod  // 受取方法（PICKUP: 本社手渡し / SHIPPING: 郵送）
  // 郵送先住所（郵送の場合必須、手渡しの場合は任意）
  postalCode        String?                     // 郵便番号
  prefecture        String?                     // 都道府県
  city              String?                     // 市区町村
  addressLine1      String?                     // 番地・建物名
  addressLine2      String?                     // 建物名・部屋番号（任意）
  // 注文詳細
  quantity          Int                         @default(100) // 部数
  notes             String?                     @db.Text // 備考（ユーザーからのメモ）
  // 決済関連
  paymentStatus     BusinessCardPaymentStatus   @default(PENDING) // 決済ステータス
  stripeSessionId   String?                     // Stripe Checkout Session ID
  stripePaymentIntentId String?                 // Stripe PaymentIntent ID
  paidAmount        Int?                        // 支払い金額（円）
  paidAt            DateTime?                   // 支払い完了日時
  // ステータス管理
  status            BusinessCardOrderStatus     @default(PENDING)
  adminNotes        String?                     @db.Text // 管理者用メモ
  processedBy       String?                     // 処理担当者（管理者ID）
  processedAt       DateTime?                   // 処理日時
  shippedAt         DateTime?                   // 発送日時
  completedAt       DateTime?                   // 完了日時
  createdAt         DateTime                    @default(now())
  updatedAt         DateTime                    @updatedAt

  user    User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  design  BusinessCardDesign  @relation(fields: [designId], references: [id], onDelete: Restrict)

  @@index([userId])
  @@index([status])
  @@index([paymentStatus])
  @@index([createdAt])
  @@map("business_card_orders")
}

// =====================
// 新着通知機能
// =====================

// カテゴリ別の最終閲覧日時（メニューバッジ用）
enum ViewCategory {
  EVENTS        // イベント
  COURSES       // 教育コンテンツ
  MATERIALS     // 資料コンテンツ
  NOTIFICATIONS // 通知
}

model UserCategoryView {
  id           String       @id @default(cuid())
  userId       String
  category     ViewCategory
  lastViewedAt DateTime     @default(now())
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, category])
  @@index([userId])
  @@map("user_category_views")
}

// コンテンツ別の閲覧履歴（NEW表示用）
enum ContentType {
  EVENT    // イベント
  COURSE   // コース（教育コンテンツ）
  LESSON   // レッスン
  MATERIAL // 資料コンテンツ
}

model UserContentView {
  id            String      @id @default(cuid())
  userId        String
  contentType   ContentType
  contentId     String
  firstViewedAt DateTime    @default(now())
  createdAt     DateTime    @default(now())
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, contentType, contentId])
  @@index([userId, contentType])
  @@map("user_content_views")
}

// =====================
// ダッシュボード新着通知機能
// =====================

// システム通知タイプ
enum SystemNotificationType {
  MATERIAL_ADDED  // 資料追加
  CONTENT_ADDED   // 教育コンテンツ追加
  EVENT_ADDED     // イベント追加
  ANNOUNCEMENT    // お知らせ
}

// システム全体の通知（資料追加、コンテンツ追加、イベント追加など）
model SystemNotification {
  id          String                  @id @default(cuid())
  type        SystemNotificationType  // 通知タイプ
  title       String                  // 通知タイトル（例: "新しい教育コンテンツ『〇〇〇〇』が追加されました"）
  contentType ContentType?            // コンテンツタイプ（EVENT, COURSE, LESSON, MATERIAL）
  contentId   String?                 // 対象コンテンツのID
  targetUrl   String?                 // 遷移先URL
  targetRoles UserRole[]              // 対象ロール（複数選択可能）
  isActive    Boolean                 @default(true) // 有効/無効
  createdAt   DateTime                @default(now())
  updatedAt   DateTime                @updatedAt
  readBy      UserNotificationRead[]  // 既読ユーザーリスト

  @@index([isActive, createdAt])
  @@map("system_notifications")
}

// ユーザーごとの通知既読管理
model UserNotificationRead {
  id             String             @id @default(cuid())
  userId         String
  notificationId String
  readAt         DateTime           @default(now())
  user           User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  notification   SystemNotification @relation(fields: [notificationId], references: [id], onDelete: Cascade)

  @@unique([userId, notificationId])
  @@index([userId])
  @@index([notificationId])
  @@map("user_notification_reads")
}

// =====================
// 個別相談機能
// =====================

// 相談ジャンル
enum ConsultationType {
  LIFE_PLAN      // ライフプラン
  HOUSING        // 住宅
  CAREER         // 転職
  RENTAL         // 賃貸
  ORDER_SUIT     // オーダースーツ作成
  SOLAR_BATTERY  // 太陽光・蓄電池
  OTHER          // その他
}

// 相談ステータス
enum ConsultationStatus {
  PENDING      // 未対応
  IN_PROGRESS  // 対応中
  COMPLETED    // 完了
}

// 希望連絡方法
enum ContactMethod {
  EMAIL  // メール
  PHONE  // 電話
  LINE   // LINE
}

// 個別相談
model Consultation {
  id                String              @id @default(cuid())
  userId            String
  user              User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  // フォーム情報
  type              ConsultationType    // 相談ジャンル
  phoneNumber       String              // 電話番号（編集可）
  content           String              @db.Text // 相談内容
  preferredContact  ContactMethod       // 希望連絡方法
  preferredDates    DateTime[]          // 希望日時（複数）
  attachmentUrl     String?             // 添付ファイルURL
  attachmentName    String?             // 添付ファイル名

  // ステータス管理
  status            ConsultationStatus  @default(PENDING)
  adminNotes        String?             @db.Text // 管理者メモ
  handledBy         String?             // 対応者ID
  handler           User?               @relation("ConsultationHandler", fields: [handledBy], references: [id], onDelete: SetNull)
  completedAt       DateTime?           // 完了日時

  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt

  @@index([userId])
  @@index([status])
  @@index([type])
  @@index([createdAt])
  @@map("consultations")
}

// =====================
// LP面談事前アンケート機能
// =====================

// 質問タイプ
enum PreInterviewQuestionType {
  TEXT          // 短いテキスト
  TEXTAREA      // 長いテキスト
  SELECT        // 単一選択（ドロップダウン）
  MULTI_SELECT  // 複数選択
  CHECKBOX      // はい/いいえ
  RADIO         // ラジオボタン
  NUMBER        // 数値
}

// 事前アンケートテンプレート（管理者が作成・編集）
model PreInterviewTemplate {
  id          String   @id @default(cuid())
  name        String   // テンプレート名（例: "LP面談事前アンケート"）
  description String?  @db.Text
  isActive    Boolean  @default(true)  // 有効/無効
  version     Int      @default(1)     // バージョン管理
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  questions   PreInterviewQuestion[]
  responses   PreInterviewResponse[]

  @@map("pre_interview_templates")
}

// 質問項目
model PreInterviewQuestion {
  id          String   @id @default(cuid())
  templateId  String
  template    PreInterviewTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  order       Int      // 表示順
  category    String?  // カテゴリ（例: "投資経験", "保険", "キャリア"）
  question    String   // 質問文
  description String?  // 補足説明

  type        PreInterviewQuestionType  // 質問タイプ
  options     Json?    // 選択肢 ["選択肢1", "選択肢2", ...]

  required    Boolean  @default(false)
  showIf      Json?    // 条件分岐（例: { "questionId": "xxx", "value": "はい" }）

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  answers     PreInterviewAnswer[]

  @@index([templateId, order])
  @@map("pre_interview_questions")
}

// 事前アンケート回答ステータス
enum PreInterviewStatus {
  PENDING      // 未開始
  IN_PROGRESS  // 回答中（途中保存）
  COMPLETED    // 完了
}

// 回答セッション（1面談につき1つ）
model PreInterviewResponse {
  id            String   @id @default(cuid())
  templateId    String
  template      PreInterviewTemplate @relation(fields: [templateId], references: [id])

  lpMeetingId   String   @unique  // LP面談と1:1で紐付け
  lpMeeting     LPMeeting @relation(fields: [lpMeetingId], references: [id], onDelete: Cascade)

  respondentId  String   // 回答者（会員）
  respondent    User     @relation("PreInterviewRespondent", fields: [respondentId], references: [id], onDelete: Cascade)

  status        PreInterviewStatus @default(PENDING)
  dueDate       DateTime?  // 回答期限（面談日の前日等）
  startedAt     DateTime?  // 回答開始日時
  completedAt   DateTime?  // 回答完了日時

  // 通知管理
  notificationSentAt    DateTime?  // 初回通知送信日時
  reminderSentAt        DateTime?  // リマインダー送信日時
  completionNotifiedAt  DateTime?  // 回答完了通知送信日時（FPへ）

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  answers       PreInterviewAnswer[]

  @@index([respondentId])
  @@index([status])
  @@index([dueDate])
  @@map("pre_interview_responses")
}

// 個別回答
model PreInterviewAnswer {
  id          String   @id @default(cuid())
  responseId  String
  response    PreInterviewResponse @relation(fields: [responseId], references: [id], onDelete: Cascade)

  questionId  String
  question    PreInterviewQuestion @relation(fields: [questionId], references: [id])

  value       Json     // 回答値（テキスト: "回答", 選択: ["選択肢1"], 数値: 100 等）

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([responseId, questionId])
  @@index([responseId])
  @@map("pre_interview_answers")
}

// =====================
// コンプライアンステスト機能
// =====================

// コンプライアンステスト問題
model ComplianceTestQuestion {
  id              String   @id @default(cuid())
  question        String   @db.Text // 設問文
  options         Json     // 選択肢（4択）: ["選択肢A", "選択肢B", "選択肢C", "選択肢D"]
  correctAnswer   Int      // 正解の選択肢インデックス（0-3）
  explanation     String?  @db.Text // 解説（不正解時に表示）
  category        String?  // カテゴリ（マネロン、コンプライアンス、個人情報保護など）
  order           Int      @default(0) // 表示順
  isActive        Boolean  @default(true) // 有効/無効
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  answers         ComplianceTestAnswer[]

  @@index([isActive, order])
  @@map("compliance_test_questions")
}

// コンプライアンステスト受験履歴
model ComplianceTestAttempt {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  totalQuestions  Int      // 問題数
  correctCount    Int      // 正解数
  score           Float    // スコア（%）
  isPassed        Boolean  // 合格したか（90%以上）

  startedAt       DateTime @default(now())
  completedAt     DateTime?
  createdAt       DateTime @default(now())

  answers         ComplianceTestAnswer[]

  @@index([userId])
  @@index([isPassed])
  @@index([createdAt])
  @@map("compliance_test_attempts")
}

// 個別回答履歴
model ComplianceTestAnswer {
  id              String   @id @default(cuid())
  attemptId       String
  attempt         ComplianceTestAttempt @relation(fields: [attemptId], references: [id], onDelete: Cascade)

  questionId      String
  question        ComplianceTestQuestion @relation(fields: [questionId], references: [id])

  selectedAnswer  Int      // 選択した回答インデックス（0-3）
  isCorrect       Boolean  // 正解かどうか

  createdAt       DateTime @default(now())

  @@unique([attemptId, questionId])
  @@index([attemptId])
  @@map("compliance_test_answers")
}

// =====================
// 全体MTG免除申請機能
// =====================

// 免除申請ステータス
enum MtgExemptionStatus {
  PENDING   // 申請中（審査待ち）
  APPROVED  // 承認
  REJECTED  // 却下
}

// 全体MTG免除申請
// 設計方針: 同一イベントに対して重複申請があった場合は、既存申請を更新する（履歴は保持しない）
// 理由: ユーザーが理由を修正したい場合に対応でき、管理者も最新の申請のみを確認すればよいため
model MtgExemption {
  id              String              @id @default(cuid())
  userId          String
  user            User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  eventId         String
  event           Event               @relation(fields: [eventId], references: [id], onDelete: Cascade)

  // 申請内容
  reason          String              @db.Text // 不参加理由（必須、20〜1000文字）

  // ステータス管理
  status          MtgExemptionStatus  @default(PENDING)
  adminNotes      String?             @db.Text // 管理者メモ（審査時のコメント）
  reviewedBy      String?             // 審査者（管理者ID）
  reviewedAt      DateTime?           // 審査日時

  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  @@unique([userId, eventId]) // 1ユーザー1イベントにつき1申請のみ
  @@index([userId])
  @@index([eventId])
  @@index([status])
  @@index([createdAt])
  @@map("mtg_exemptions")
}
