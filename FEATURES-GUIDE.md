# UGSオンラインスクール 機能ガイド

このドキュメントでは、UGSオンラインスクールに実装されているすべての機能とその使い方を説明します。

---

## 📋 目次

1. [紹介管理機能](#紹介管理機能)
2. [契約管理機能](#契約管理機能)
3. [通知機能](#通知機能)
4. [昇格申請機能](#昇格申請機能)
5. [基礎テスト機能](#基礎テスト機能)
6. [アンケート機能](#アンケート機能)
7. [報酬管理機能（管理者）](#報酬管理機能管理者)
8. [イベント管理機能](#イベント管理機能)
9. [LP面談機能](#lp面談機能)
10. [パスワードリセット機能](#パスワードリセット機能)
11. [サブスクリプション管理機能](#サブスクリプション管理機能)

---

## 1. 紹介管理機能

### 概要
FPエイド以上のユーザーが、新しいメンバーを紹介し、紹介実績を管理するための機能です。

### アクセス権限
- **アクセス可能**: FPエイド（`fp`）、マネージャー（`manager`）、管理者（`admin`）
- **アクセス不可**: 一般会員（`member`）

### 機能詳細

#### 1.1 紹介コードの表示・共有
- **場所**: `/dashboard/referrals`
- **機能**:
  - ユーザーごとに自動生成された8文字の紹介コードを表示
  - 紹介リンク（`/register?ref={紹介コード}`）をクリップボードにコピー
  - 紹介コードを直接共有することも可能

#### 1.2 紹介統計の表示
以下の統計情報を表示します：
- **総紹介数**: これまでに紹介したメンバーの総数
- **UGS会員紹介数**: 一般会員として紹介した人数
- **FPエイド紹介数**: FPエイドとして紹介した人数

#### 1.3 紹介一覧の表示
- 紹介したメンバーの一覧を表示
- 各紹介の情報：
  - 被紹介者の名前・メールアドレス
  - 紹介タイプ（UGS会員紹介 / FPエイド紹介）
  - ステータス（審査中 / 承認済み / 却下）
  - 紹介日時

### 使い方

1. **紹介コードを取得**
   - サイドバーから「紹介管理」をクリック
   - 画面上部に表示される紹介コードを確認
   - 「コピー」ボタンをクリックして紹介リンクをコピー

2. **紹介リンクを共有**
   - コピーした紹介リンクを新規ユーザーに共有
   - または紹介コードを直接共有

3. **紹介の確認**
   - 新規ユーザーが紹介リンク経由で登録・決済完了後、自動的に紹介が登録される
   - 「紹介一覧」で紹介状況を確認

4. **紹介の審査**
   - 管理者が紹介を承認または却下（管理者機能）

### APIエンドポイント

- `GET /api/referrals?userId={userId}` - 紹介一覧を取得
- `POST /api/referrals` - 紹介を登録（通常は自動）
- `POST /api/referrals/{referralId}/approve` - 紹介を承認（管理者）
- `POST /api/referrals/{referralId}/reject` - 紹介を却下（管理者）
- `POST /api/referrals/register` - 紹介コードを使用して紹介を登録

---

## 2. 契約管理機能

### 概要
FPエイド以上のユーザーが、保険契約などの契約実績を登録・管理するための機能です。

### アクセス権限
- **アクセス可能**: FPエイド（`fp`）、マネージャー（`manager`）、管理者（`admin`）
- **アクセス不可**: 一般会員（`member`）

### 機能詳細

#### 2.1 契約の登録
以下の情報を入力して契約を登録できます：
- **契約番号**: 契約を識別するための番号（必須）
- **契約タイプ**: 保険契約 / その他（必須）
- **契約日**: 契約を締結した日付（必須）
- **契約金額**: 契約の金額（任意）

#### 2.2 契約統計の表示
以下の統計情報を表示します：
- **有効契約数**: 現在有効な契約の数
- **総契約数**: 登録されている契約の総数
- **契約報酬合計**: 有効契約の報酬額の合計

#### 2.3 契約一覧の表示
- 登録した契約の一覧を表示
- 各契約の情報：
  - 契約番号
  - 契約タイプ
  - 契約日
  - 契約金額
  - 報酬額（設定されている場合）
  - ステータス（有効 / 解約 / 期限切れ）

### 使い方

1. **契約を登録**
   - サイドバーから「契約管理」をクリック
   - 「契約を追加」ボタンをクリック
   - 契約情報を入力して「登録」ボタンをクリック

2. **契約を確認**
   - 「契約一覧」で登録した契約を確認
   - 統計情報で契約実績を把握

3. **契約を更新・削除**
   - 管理者が契約情報を更新・削除可能（管理者機能）

### APIエンドポイント

- `GET /api/contracts?userId={userId}` - 契約一覧を取得
- `POST /api/contracts` - 契約を登録
- `PUT /api/contracts/{contractId}` - 契約を更新（管理者）
- `DELETE /api/contracts/{contractId}` - 契約を削除（管理者）

---

## 3. 通知機能

### 概要
システムからの重要な通知を受け取り、管理するための機能です。

### アクセス権限
- **アクセス可能**: すべてのロール（`member`, `fp`, `manager`, `admin`）

### 機能詳細

#### 3.1 通知の種類
以下の種類の通知があります：
- **昇格関連**: 昇格申請の承認・却下、昇格条件達成の通知
- **報酬関連**: 報酬の準備完了、報酬の支払い完了
- **イベント関連**: イベントのリマインダー、必須イベントの通知
- **紹介関連**: 紹介の承認・却下
- **契約関連**: 契約達成の通知
- **その他**: アクションが必要な通知

#### 3.2 通知の優先度
- **重要（CRITICAL）**: 緊急の対応が必要な通知
- **情報（INFO）**: 一般的な情報通知
- **成功（SUCCESS）**: 成功を伝える通知

#### 3.3 通知の管理
- **未読/既読の管理**: 通知を個別に既読にする
- **一括既読**: すべての通知を一度に既読にする
- **通知の表示**: 未読通知と既読通知を分けて表示

### 使い方

1. **通知を確認**
   - サイドバーから「通知」をクリック
   - 未読通知が上部に表示される
   - 既読通知は下部に表示される

2. **通知を既読にする**
   - 個別に既読にする: 通知の右側のチェックボタンをクリック
   - 一括既読にする: 「すべて既読にする」ボタンをクリック

3. **通知の詳細を確認**
   - 通知に「詳細を見る」リンクがある場合、クリックして詳細ページに移動

### APIエンドポイント

- `GET /api/notifications?userId={userId}` - 通知一覧を取得
- `POST /api/notifications` - 通知を作成（システム内部）
- `POST /api/notifications/{notificationId}/read` - 通知を既読にする
- `POST /api/notifications/mark-all-read` - すべての通知を既読にする

---

## 4. 昇格申請機能

### 概要
ユーザーが次のロールに昇格するための申請を行う機能です。

### アクセス権限
- **FPエイド昇格**: 一般会員（`member`）のみ
- **マネージャー昇格**: FPエイド（`fp`）のみ

### 機能詳細

#### 4.1 FPエイド昇格申請

**昇格条件**:
1. **基礎編テスト合格**: 基礎編テスト（10問）に70%以上で合格する
2. **LP面談完了**: ライフプランナーとの面談を完了する
3. **アンケート提出**: 初回アンケート（10設問）を提出する

**申請手順**:
1. **基礎編テストを受験**
   - サイドバーから「基礎テスト」をクリック
   - 10問のテストに回答
   - 70%以上で合格すると自動的に条件が更新される
2. **LP面談を予約**
   - サイドバーから「LP面談予約」をクリック
   - 希望日時を5つ選択して申請
   - 面談完了後、自動的に条件が更新される
3. **アンケートに回答**
   - サイドバーから「アンケート」をクリック
   - 10設問のアンケートに回答して提出
   - 提出後、自動的に条件が更新される
4. **身分証のアップロード**
   - 運転免許証、パスポートなどの身分証の画像をアップロード
   - ファイル形式: JPEG、PNG、PDF
   - ファイルサイズ: 10MB以下
5. **業務委託契約書の締結**
   - 業務委託契約書（GMOサイン）のリンクを確認
   - 契約書の内容を確認し、同意チェックボックスにチェック
6. **昇格申請の送信**
   - すべての条件を満たし、身分証をアップロードし、契約書に同意した後、「FPエイド昇格申請」ボタンをクリック

#### 4.2 マネージャー昇格申請

**昇格条件**:
1. 報酬実績: 直近3ヶ月の平均報酬が一定額以上
2. UGS会員紹介: 6ヶ月間に一定数のUGS会員を紹介
3. FPエイド紹介: 6ヶ月間に一定数のFPエイドを紹介
4. 契約実績: 直近20件の保険契約を達成

**申請手順**:
1. 昇格可能性の確認
   - 「昇格管理」ページで各条件の達成状況を確認
   - 進捗バーで各条件の達成度を視覚的に確認
2. 昇格申請の送信
   - すべての条件を満たした後、「マネージャー昇格を申請」ボタンをクリック

### 使い方

1. **FPエイド昇格申請**
   - サイドバーから「昇格管理」をクリック
   - 昇格条件の達成状況を確認
   - 身分証をアップロード
   - 「FPエイド昇格申請」ボタンをクリック

2. **マネージャー昇格申請**
   - サイドバーから「昇格管理」をクリック
   - 昇格条件の達成状況を確認
   - 「マネージャー昇格を申請」ボタンをクリック

3. **申請状況の確認**
   - 申請後、管理者による審査が行われます
   - 審査結果は通知でお知らせします

### APIエンドポイント

- `GET /api/promotions/eligibility?userId={userId}&targetRole={role}` - 昇格可能性をチェック
- `POST /api/promotions/apply` - 昇格申請を送信
- `POST /api/user/upload-id-document` - 身分証をアップロード（FP昇格用）
- `GET /api/user/get-id-document-url?userId={userId}` - アップロードした身分証のURLを取得
- `GET /api/user/fp-promotion-application?userId={userId}` - FP昇格申請情報を取得
- `GET /api/user/contract-url` - 業務委託契約書のURLを取得
- `POST /api/user/fp-promotion-apply` - FPエイド昇格申請を送信
- `POST /api/admin/promotions/{applicationId}/approve` - 昇格申請を承認（管理者）
- `POST /api/admin/promotions/{applicationId}/reject` - 昇格申請を却下（管理者）

---

## 5. 基礎テスト機能

### 概要
FPエイド昇格の条件の一つである「基礎編テスト合格」を実現するため、メンバーが基礎編テストを受験する機能です。

### アクセス権限
- **アクセス可能**: 一般会員（`member`）のみ
- **アクセス不可**: FPエイド以上のロール

### 機能詳細

#### 5.1 テストの受験
- **問題数**: 10問
- **合格基準**: 70%以上（7問以上正解）
- **制限時間**: なし（時間制限なし）
- **再受験**: 合格するまで何度でも受験可能

#### 5.2 テスト結果の表示
- **スコア**: 得点率（%）を表示
- **合格/不合格**: 70%以上で合格
- **合格後**: 自動的に`FPPromotionApplication`の`basicTestCompleted`が更新される

### 使い方

1. **テストを受験**
   - サイドバーから「基礎テスト」をクリック（昇格管理ページからもアクセス可能）
   - または昇格管理ページの「テストを受ける」ボタンをクリック
   - 10問のテストに回答
   - 「テストを提出」ボタンをクリック

2. **結果を確認**
   - 提出後、スコアと合格/不合格が表示される
   - 合格した場合、昇格条件の「基礎編テスト合格」が自動的に完了になる
   - 不合格の場合、再度受験可能

### APIエンドポイント

- `GET /api/basic-test?userId={userId}` - テストとテスト結果を取得
- `POST /api/basic-test` - テストを提出
- `GET /api/admin/basic-test` - テストを管理（管理者）
- `POST /api/admin/basic-test` - テストを作成・更新（管理者）

---

## 6. アンケート機能

### 概要
FPエイド昇格の条件の一つである「アンケート提出」を実現するため、メンバーが初回アンケートに回答する機能です。

### アクセス権限
- **アクセス可能**: 一般会員（`member`）のみ
- **アクセス不可**: FPエイド以上のロール

### 機能詳細

#### 6.1 アンケートの回答
- **設問数**: 10設問
- **回答形式**: テキスト入力（textarea）
- **必須項目**: すべての設問が必須
- **再提出**: 提出後は再提出不可（1回のみ）

#### 6.2 アンケート提出の確認
- **提出後**: 自動的に`FPPromotionApplication`の`surveyCompleted`が更新される
- **提出済み**: 既に提出済みの場合は、提出済みである旨が表示される

### 使い方

1. **アンケートに回答**
   - サイドバーから「アンケート」をクリック（昇格管理ページからもアクセス可能）
   - または昇格管理ページの「アンケートに回答」ボタンをクリック
   - 10設問のアンケートに回答
   - 「アンケートを提出」ボタンをクリック

2. **提出を確認**
   - 提出後、昇格条件の「アンケート提出」が自動的に完了になる
   - 提出済みの場合は、再度回答することはできません

### APIエンドポイント

- `GET /api/survey?userId={userId}` - アンケートと提出状況を取得
- `POST /api/survey` - アンケートを提出
- `GET /api/admin/survey` - アンケートを管理（管理者）
- `POST /api/admin/survey` - アンケートを作成・更新（管理者）

---

## 7. 報酬管理機能（管理者）

### 概要
管理者が全ユーザーの月次報酬を生成・承認・支払い管理するための機能です。

### アクセス権限
- **アクセス可能**: 管理者（`admin`）のみ
- **アクセス不可**: その他のすべてのロール

### 機能詳細

#### 7.1 月次報酬の生成
- 指定した月の報酬を自動計算して生成
- 報酬の内訳：
  - 契約報酬
  - ボーナス
  - 控除
- **注意**: 紹介報酬は現在無効化されています

#### 7.2 報酬の承認
- 生成された報酬を確認し、承認する
- 承認後、ユーザーに通知が送信される

#### 7.3 報酬の支払い管理
- 承認済みの報酬を支払い済みとしてマーク
- 支払い完了後、ユーザーに通知が送信される

### 使い方

1. **報酬を生成**
   - サイドバーから「報酬管理（管理者）」をクリック
   - 「報酬を生成」ボタンをクリック
   - 対象月（YYYY-MM形式）を入力
   - 「報酬を生成」ボタンをクリック

2. **報酬を承認**
   - 生成された報酬一覧を確認
   - 各報酬の「承認」ボタンをクリック

3. **報酬を支払い済みにする**
   - 承認済みの報酬の「支払済み」ボタンをクリック
   - 支払い完了後、ステータスが「支払済み」に更新される

### APIエンドポイント

- `POST /api/admin/compensations/generate` - 月次報酬を生成
- `POST /api/admin/compensations/{compensationId}/approve` - 報酬を承認
- `POST /api/admin/compensations/{compensationId}/pay` - 報酬を支払い済みにする

---

## 8. イベント管理機能

### 概要
イベントの作成・登録・管理を行う機能です。

### アクセス権限

#### 8.1 イベント参加（メンバー）
- **アクセス可能**: すべてのロール（`member`, `fp`, `manager`, `admin`）

#### 8.2 イベント管理（管理者）
- **アクセス可能**: 管理者（`admin`）のみ

### 機能詳細

#### 8.1 イベントの参加
- 開催予定のイベント一覧を表示
- イベントに参加登録・キャンセル
- イベントの詳細情報を確認

#### 8.2 イベントの作成・削除（管理者）
- 新しいイベントを作成
- イベントの情報を設定：
  - イベント名
  - 日時
  - イベントタイプ（必須 / 任意 / マネージャーのみ）
  - オンライン/オフライン
  - 場所
  - 最大参加者数
- イベントを削除

### 使い方

1. **イベントに参加（メンバー）**
   - サイドバーから「イベント」をクリック
   - 参加したいイベントの「参加登録」ボタンをクリック
   - キャンセルする場合は「キャンセル」ボタンをクリック

2. **イベントを作成（管理者）**
   - サイドバーから「イベント管理（管理者）」をクリック
   - 「イベントを作成」ボタンをクリック
   - イベント情報を入力して「作成」ボタンをクリック

3. **イベントを削除（管理者）**
   - イベント一覧から削除したいイベントの「削除」ボタンをクリック

### APIエンドポイント

- `GET /api/events` - イベント一覧を取得
- `POST /api/events/register` - イベントに参加登録・キャンセル
- `POST /api/admin/events` - イベントを作成（管理者）
- `DELETE /api/admin/events/{eventId}` - イベントを削除（管理者）

---

## 9. LP面談機能

### 概要
FPエイド昇格の条件の一つである「LP面談完了」を実現するため、FPエイドがメンバーとオンライン面談を行うための予約・管理システムです。

### アクセス権限

#### 9.1 面談予約申請（メンバー）
- **アクセス可能**: 一般会員（`member`）のみ

#### 9.2 面談管理（FPエイド）
- **アクセス可能**: FPエイド（`fp`）のみ

#### 9.3 面談管理（管理者）
- **アクセス可能**: 管理者（`admin`）のみ

### 機能詳細

#### 9.1 メンバー側: LP面談予約申請

**機能**:
- 面談希望日時の入力（**5つ選択**、必須）
- 要望・質問事項の入力（任意）
- 現在の予約状況の表示
- 予約申請の送信

**表示内容**:
- 現在の予約ステータス（未申請 / 申請中 / 予約済み / 完了）
- 申請中の場合: 申請した希望日時（5つ）
- 予約済みの場合: 確定日時、FPエイド名、オンライン面談のURL
- 完了の場合: 完了日時、FPエイドからのメモ

**フロー**:
1. メンバーが希望日時を5つ選択して申請
2. 運営側（管理者）に通知が送信される
3. 運営側が希望日時とFPエイドを選択して面談を確定
4. メンバーとFPエイドの両方に通知が送信される
5. 面談実施（オンライン）
6. FPエイドが面談完了を確認
7. `FPPromotionApplication`の`lpMeetingCompleted`が自動更新

#### 9.2 運営側（管理者）: LP面談管理

**機能**:
- 予約申請一覧の表示（ステータス: REQUESTED）
- 希望日時とFPエイドの選択
- オンライン面談URLの設定
- 面談の確定
- 全面談の一覧表示・管理
- 統計情報の表示

**表示内容**:
- 予約申請一覧（ステータス: REQUESTED）
- 各申請の詳細情報:
  - メンバー名・メールアドレス
  - 希望日時（5つ、選択可能）
  - 要望・質問事項
- 確定済み面談一覧
- 統計情報（申請数、確定数、完了数等）

**操作フロー**:
1. 申請をクリックして詳細を表示
2. 希望日時から1つを選択（ドロップダウン）
3. FPエイドを選択（ドロップダウン）
4. プラットフォームを選択（Zoom、Google Meet、Teams、その他）
5. オンライン面談URLを入力
6. 「面談を確定」ボタンをクリック

#### 9.3 FPエイド側: LP面談管理

**機能**:
- 確定された面談一覧の表示（自分の面談のみ）
- 面談の詳細確認
- 面談完了の確認
- 面談メモの記入

**表示内容**:
- 確定済み面談一覧（ステータス: SCHEDULED）
- 各面談の詳細情報:
  - メンバー名・メールアドレス
  - 面談日時
  - オンライン面談のURL
  - メンバーの要望・質問事項
- 完了済み面談一覧

### 使い方

1. **メンバー: LP面談予約申請**
   - サイドバーから「LP面談予約」をクリック
   - 希望日時を5つ選択（datetime-local入力）
   - 要望・質問事項を入力（任意）
   - 「面談予約を申請」ボタンをクリック

2. **管理者: 面談を確定**
   - サイドバーから「LP面談管理（管理者）」をクリック
   - 申請中の面談一覧から確定したい面談を選択
   - 希望日時から1つを選択
   - FPエイドを選択
   - プラットフォームを選択
   - オンライン面談URLを入力
   - 「面談を確定」ボタンをクリック

3. **FPエイド: 面談完了の確認**
   - サイドバーから「LP面談管理」をクリック
   - 予約済み面談一覧から完了した面談を選択
   - 「完了」ボタンをクリック
   - 面談メモを記入（任意）
   - 「面談完了を確認」ボタンをクリック

### APIエンドポイント

- `POST /api/lp-meetings/request` - 面談予約申請（メンバー）
- `GET /api/lp-meetings/my-meeting?userId={userId}` - 自分の面談状況取得（メンバー）
- `GET /api/admin/lp-meetings` - 面談一覧取得（管理者）
- `POST /api/admin/lp-meetings/{meetingId}/schedule` - 面談を確定（管理者）
- `GET /api/lp-meetings/my-scheduled?fpId={fpId}` - 自分の面談一覧取得（FPエイド）
- `POST /api/lp-meetings/{meetingId}/complete` - 面談完了の確認（FPエイド）

---

## 10. パスワードリセット機能

### 概要
パスワードを忘れた場合に、メールアドレスを使用してパスワードをリセットする機能です。

### アクセス権限
- **アクセス可能**: すべてのユーザー（未ログイン状態）

### 機能詳細

#### 10.1 パスワードリセットの申請
- **場所**: `/forgot-password`
- **機能**:
  - 登録済みのメールアドレスを入力
  - パスワードリセットメールを送信
  - メール内のリンクからパスワードをリセット

#### 10.2 パスワードの再設定
- **場所**: `/reset-password`
- **機能**:
  - メール内のリンクからアクセス
  - 新しいパスワードを設定（6文字以上）
  - パスワード確認の入力
  - パスワードを更新

### 使い方

1. **パスワードリセットを申請**
   - ログインページの「パスワードを忘れた場合」リンクをクリック
   - または `/forgot-password` に直接アクセス
   - 登録済みのメールアドレスを入力
   - 「パスワードリセットメールを送信」ボタンをクリック

2. **メールを確認**
   - 送信されたメール内のリンクをクリック
   - リンクは1時間有効

3. **パスワードを再設定**
   - リセットページで新しいパスワードを入力（6文字以上）
   - パスワード確認を入力
   - 「パスワードを更新」ボタンをクリック
   - 更新後、自動的にログインページにリダイレクト

### 注意事項

- **リンクの有効期限**: パスワードリセットリンクは1時間有効です
- **同じパスワード**: 現在のパスワードと同じパスワードは設定できません
- **エラーメッセージ**: エラーメッセージは日本語で表示されます

### APIエンドポイント

- `POST /api/auth/reset-password` - パスワードリセットメールを送信

---

### ロール別アクセス権限一覧

| 機能 | member | fp | manager | admin |
|------|--------|----|---------|-------|
| 紹介管理 | ❌ | ✅ | ✅ | ✅ |
| 契約管理 | ❌ | ✅ | ✅ | ✅ |
| 通知 | ✅ | ✅ | ✅ | ✅ |
| FPエイド昇格申請 | ✅ | ❌ | ❌ | ❌ |
| マネージャー昇格申請 | ❌ | ✅ | ❌ | ❌ |
| 基礎テスト | ✅ | ❌ | ❌ | ❌ |
| アンケート | ✅ | ❌ | ❌ | ❌ |
| LP面談予約 | ✅ | ❌ | ❌ | ❌ |
| LP面談管理 | ❌ | ✅ | ❌ | ❌ |
| LP面談管理（管理者） | ❌ | ❌ | ❌ | ✅ |
| 報酬管理（管理者） | ❌ | ❌ | ❌ | ✅ |
| イベント参加 | ✅ | ✅ | ✅ | ✅ |
| イベント管理（管理者） | ❌ | ❌ | ❌ | ✅ |
| パスワードリセット | ✅ | ✅ | ✅ | ✅ |

### ナビゲーション

各機能へのアクセスは、サイドバーのナビゲーションメニューから行えます：

- **紹介管理**: `/dashboard/referrals`
- **契約管理**: `/dashboard/contracts`
- **通知**: `/dashboard/notifications`
- **昇格管理**: `/dashboard/promotion`
- **基礎テスト**: `/dashboard/basic-test`（メンバー）
- **アンケート**: `/dashboard/survey`（メンバー）
- **LP面談予約**: `/dashboard/lp-meeting/request`（メンバー）
- **LP面談管理**: `/dashboard/lp-meeting/manage`（FPエイド）
- **LP面談管理（管理者）**: `/dashboard/admin/lp-meetings`（管理者）
- **報酬管理（管理者）**: `/dashboard/admin/compensations`
- **イベント**: `/dashboard/events`
- **イベント管理（管理者）**: `/dashboard/admin/events`
- **パスワードリセット**: `/forgot-password`、`/reset-password`
- **サブスクリプション管理**: `/dashboard/settings/subscription`

### 注意事項

1. **紹介コード**: 各ユーザーには自動的に紹介コードが生成されます。紹介コードはユニークで、変更できません。

2. **昇格申請**: 
   - FPエイド昇格申請には以下の条件が必要です：
     - 基礎編テスト合格（70%以上）
     - LP面談完了
     - アンケート提出
     - 身分証のアップロード
     - 業務委託契約書（GMOサイン）の締結
   - マネージャー昇格申請にはすべての条件を満たす必要があります

3. **報酬管理**: 
   - 報酬は管理者が月次で生成します
   - 報酬の承認・支払いは管理者が行います

4. **LP面談**: 
   - 面談はオンラインのみ対応
   - 希望日時は5つ選択する必要がある
   - 運営側が希望日時とFPエイドを選択して面談を確定
   - 面談完了後、FPエイド昇格の条件が自動的に更新される

5. **イベント**: 
   - 必須イベントは参加が必須です
   - マネージャー限定イベントはマネージャー以上のロールのみ参加可能です

6. **サブスクリプション管理**: 
   - 決済失敗やキャンセル時はダッシュボードへのアクセスが制限されます
   - 設定ページは常にアクセス可能です
   - 管理者は常にアクセス可能です
   - カード情報の変更はStripe Customer Portalで行います

---

## 11. サブスクリプション管理機能

### 概要
ユーザーが自分のサブスクリプション（決済情報）を管理するための機能です。サブスクリプションの状態確認、カード情報の変更、キャンセル・再開、請求履歴の確認ができます。

### アクセス権限
- **アクセス可能**: すべての認証済みユーザー
- **アクセス不可**: 未認証ユーザー

### 機能詳細

#### 11.1 サブスクリプション情報の表示
- **場所**: `/dashboard/settings/subscription`
- **表示内容**:
  - **ステータス**: 有効、未払い、キャンセル済み
  - **月額料金**: ¥5,500
  - **現在の期間**: 開始日〜終了日
  - **次回請求日**: 次回の自動決済予定日
  - **登録カード情報**: カードブランド、下4桁、有効期限

#### 11.2 警告メッセージ
以下の場合に警告メッセージが表示されます：
- **決済失敗時**: 「決済が失敗しました。カード情報を更新して決済を完了してください。」
- **キャンセル予定時**: 「現在の期間終了時にサブスクリプションがキャンセルされます。」

#### 11.3 カード情報の変更
- **機能**: Stripe Customer Portalを使用したカード情報の更新
- **処理**:
  1. 「カード情報を変更」ボタンをクリック
  2. Stripe Customer Portalが開く
  3. カード情報を更新・追加
  4. 更新後、自動的にサブスクリプション管理ページに戻る

#### 11.4 サブスクリプションのキャンセル
- **機能**: サブスクリプションをキャンセル（期間終了時にキャンセル）
- **処理**:
  1. 「キャンセル」ボタンをクリック
  2. 確認ダイアログで確認
  3. 現在の期間終了時に自動的にキャンセルされる
  4. キャンセル予定の警告が表示される
  5. キャンセル確認メールが送信される

#### 11.5 サブスクリプションの再開
- **機能**: キャンセル予定のサブスクリプションを再開
- **処理**:
  1. 「サブスクリプションを再開」ボタンをクリック
  2. サブスクリプションが即座に再開される
  3. 次回請求日が更新される

#### 11.6 請求履歴の表示
- **機能**: 過去の請求書一覧を表示
- **表示内容**:
  - 請求期間（開始日〜終了日）
  - 請求金額
  - ステータス（支払済み、未払い、無効）
  - 請求書PDFへのリンク
- **表示件数**: 最大12件（直近）

### 使い方

1. **サブスクリプション管理ページにアクセス**
   - サイドバーから「設定」をクリック
   - 「サブスクリプション管理」をクリック

2. **サブスクリプション情報を確認**
   - 現在のステータス、月額料金、期間を確認
   - 登録されているカード情報を確認

3. **カード情報を変更**
   - 「カード情報を変更」ボタンをクリック
   - Stripe Customer Portalでカード情報を更新

4. **サブスクリプションをキャンセル**
   - 「キャンセル」ボタンをクリック
   - 確認ダイアログで「OK」をクリック
   - 現在の期間終了時にキャンセルされる

5. **サブスクリプションを再開**
   - キャンセル予定の場合、「サブスクリプションを再開」ボタンをクリック
   - 即座に再開される

6. **請求履歴を確認**
   - 「請求履歴」セクションで過去の請求書を確認
   - 「請求書を見る」ボタンでPDFを表示

### アクセス制限について

以下の状態の場合、ダッシュボードへのアクセスが制限されます：
- **未払い（PAST_DUE）**: 決済が失敗した場合
- **未払い（UNPAID）**: 決済が完了していない場合
- **キャンセル済み（CANCELED）**: サブスクリプションがキャンセルされた場合

制限された場合：
- アクセス制限の警告画面が表示される
- サブスクリプション管理ページへのリンクが表示される
- 設定ページ（`/dashboard/settings/*`）は常にアクセス可能
- 管理者は常にアクセス可能

### メール通知

以下の場合にメール通知が送信されます：
- **決済失敗時**: カード情報更新への案内メール
- **キャンセル時**: キャンセル確認と再開への案内メール

### APIエンドポイント

- `GET /api/user/subscription` - サブスクリプション情報を取得
- `POST /api/user/subscription/cancel` - サブスクリプションをキャンセル
- `POST /api/user/subscription/reactivate` - サブスクリプションを再開
- `POST /api/user/subscription/update-payment-method` - カード情報更新用のCustomer Portalセッションを作成
- `GET /api/user/subscription/invoices` - 請求履歴を取得

### 注意事項

- キャンセル後も現在の期間が終了するまでサービスを利用できます
- カード情報の変更はStripe Customer Portalで行います
- 決済失敗が続く場合、サービスへのアクセスが制限される可能性があります
- 請求履歴は最大12件まで表示されます

---

## 🔗 関連ドキュメント

- [テストガイド](./TEST-GUIDE.md) - 機能のテスト方法
- [実装サマリー](./IMPLEMENTATION-SUMMARY.md) - 実装の詳細
- [README](./README.md) - プロジェクトの概要

---

**最終更新**: 2025年1月

