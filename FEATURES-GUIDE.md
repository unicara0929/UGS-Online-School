# UGSオンラインスクール 機能ガイド

このドキュメントでは、UGSオンラインスクールに実装されているすべての機能とその使い方を説明します。

---

## 📋 目次

1. [教育コンテンツ機能](#教育コンテンツ機能)
2. [資料コンテンツ機能](#資料コンテンツ機能)
3. [紹介管理機能](#紹介管理機能)
4. [契約管理機能](#契約管理機能)
5. [報酬管理機能](#報酬管理機能)
6. [CSV一括アップロード機能](#csv一括アップロード機能)
7. [通知機能](#通知機能)
8. [昇格申請機能](#昇格申請機能)
9. [基礎テスト機能](#基礎テスト機能)
10. [アンケート機能](#アンケート機能)
11. [イベント管理機能](#イベント管理機能)
12. [LP面談機能](#lp面談機能)
13. [チーム管理機能](#チーム管理機能)
14. [動画ガイダンス機能](#動画ガイダンス機能)
15. [サブスクリプション管理機能](#サブスクリプション管理機能)
16. [プロフィール・アカウント設定](#プロフィールアカウント設定)
17. [パスワードリセット機能](#パスワードリセット機能)
18. [管理者機能](#管理者機能)

---

## 1. 教育コンテンツ機能

### 概要
学習動画やレッスンコンテンツを視聴し、進捗を管理するための機能です。初心者から上級者まで、段階的に学習できるコース体系を提供しています。

### アクセス権限
- **アクセス可能**: すべてのロール（`member`, `fp`, `manager`, `admin`）
- **ロック解除コンテンツ**: FPエイド以上（`fp`, `manager`, `admin`）のみアクセス可能なコンテンツあり

### 機能詳細

#### 1.1 コース体系
コースは以下の3つのカテゴリーに分類されています：
- **BASIC（基礎編）**: 収入を得るための基礎知識
- **PRACTICAL（実践編）**: ライフスタイル向上のための実践的な知識
- **ADVANCED（応用編）**: 起業・独立を目指す方向けの高度な内容

各コースには以下のレベルがあります：
- **BEGINNER（初級）**: 初心者向けの基本的な内容
- **INTERMEDIATE（中級）**: ある程度の知識がある方向け
- **ADVANCED（上級）**: 上級者向けの専門的な内容

#### 1.2 コース一覧の表示
- **場所**: `/dashboard/courses`
- **表示内容**:
  - カテゴリー別のコース一覧
  - 各コースの進捗状況（完了率）
  - コースのレベル（初級・中級・上級）
  - ロック状態（FPエイド限定コンテンツ）

#### 1.3 レッスンの視聴と進捗管理
- **場所**: `/dashboard/learn/[courseId]`
- **機能**:
  - Vimeo動画プレイヤーでレッスンを視聴
  - レッスンの視聴進捗を自動保存（90%以上視聴で完了）
  - コース全体の進捗率を表示
  - 次のレッスンへの自動遷移

#### 1.4 FPエイド限定コンテンツ
一部のコースは`isLocked`フラグが設定されており、FPエイド以上のロールのみアクセス可能です。一般会員（MEMBER）の場合は、ロック解除のためにFPエイド昇格が必要であることが表示されます。

### 使い方

1. **コース一覧を確認**
   - サイドバーから「コンテンツ」→「教育コンテンツ」をクリック
   - カテゴリー別にコースを確認
   - 進捗状況を確認

2. **レッスンを視聴**
   - コースをクリックしてレッスン一覧を表示
   - 視聴したいレッスンを選択
   - 動画を視聴（90%以上視聴で自動的に完了）

3. **進捗を確認**
   - コース一覧で各コースの完了率を確認
   - レッスンページで視聴済みレッスンを確認

### APIエンドポイント

- `GET /api/courses` - コース一覧と進捗を取得
- `GET /api/courses/[courseId]` - 特定のコースとレッスンを取得
- `POST /api/courses/progress` - レッスンの進捗を更新

### データベースモデル
- `Course` - コース情報（カテゴリー、レベル、ロック状態）
- `Lesson` - レッスン情報（タイトル、動画URL、順序）
- `CourseProgress` - ユーザーのレッスン視聴進捗

---

## 2. 資料コンテンツ機能

### 概要
PDFやマニュアルなどの資料をダウンロードできる機能です。教育コンテンツとは別に、各種マニュアルやテンプレートなどの資料を提供します。

### アクセス権限
- **アクセス可能**: ロールに応じた資料（資料ごとに閲覧可能ロールが設定されている）
- **資料のアップロード・管理**: 管理者（`admin`）のみ

### 機能詳細

#### 2.1 資料一覧の表示
- **場所**: `/dashboard/materials`
- **機能**:
  - 資料の一覧表示
  - カテゴリ別の分類表示
  - ファイル形式（PDF、DOCXなど）とサイズの表示
  - ダウンロードボタン

#### 2.2 資料の種類
以下のような資料を提供します：
- **マニュアル**: UGSオンラインスクールの使い方、FPエイド活動マニュアルなど
- **制度説明**: 紹介制度、報酬制度などの説明資料
- **テンプレート**: 昇格申請書類などのテンプレート

#### 2.3 資料の管理（管理者）
- **機能**:
  - 資料のアップロード（Supabase Storageに保存）
  - 資料の編集・削除
  - 閲覧可能ロールの設定（ADMIN、MANAGER、FP、MEMBER）
  - カテゴリーの設定

### 使い方

1. **資料コンテンツページにアクセス**
   - サイドバーから「コンテンツ」をクリック
   - 「資料コンテンツ」を選択

2. **資料を確認**
   - 資料一覧から目的の資料を探す
   - カテゴリやファイル形式でフィルタリング可能

3. **資料をダウンロード**
   - 「ダウンロード」ボタンをクリック
   - ファイルがダウンロードされる

### APIエンドポイント

- `GET /api/materials` - アクセス可能な資料一覧を取得（ユーザー）
- `GET /api/admin/materials` - すべての資料を取得（管理者）
- `POST /api/admin/materials` - 資料を作成（管理者）
- `PATCH /api/admin/materials/[materialId]` - 資料を更新（管理者）
- `DELETE /api/admin/materials/[materialId]` - 資料を削除（管理者）
- `POST /api/admin/materials/upload` - ファイルをアップロード（管理者）

### データベースモデル
- `Material` - 資料情報（タイトル、ファイルURL、閲覧可能ロール）

### ナビゲーション構造

ナビゲーションメニューは以下の階層構造になっています：

```
コンテンツ
├── 教育コンテンツ（学習用の動画や講義コンテンツ）
└── 資料コンテンツ（PDFやマニュアルなどの資料）
```

### 注意事項

- 資料の追加・更新は管理者が行います
- ダウンロード可能な資料は、ユーザーのロールに応じて表示が制限される場合があります
- ファイルはSupabase Storageに保存されます

---

## 3. 紹介管理機能

### 概要
FPエイド以上のユーザーが、新しいメンバーを紹介し、紹介実績を管理するための機能です。**紹介リンク発行形式**を採用しており、各ユーザーが独自の紹介リンクを発行し、そのリンク経由で登録したユーザーが自動的に紹介として紐付けられます。

### アクセス権限
- **アクセス可能**: FPエイド（`fp`）、マネージャー（`manager`）、管理者（`admin`）
- **アクセス不可**: 一般会員（`member`）

### 機能詳細

#### 1.1 紹介リンク発行形式

**仕組み**:
- 各ユーザーには自動的にユニークな8文字の紹介コードが生成されます
- 紹介コードを使用して紹介リンク（`/register?ref={紹介コード}`）を作成できます
- この紹介リンクを新規ユーザーに共有することで、紹介を実施します

**紹介の紐付け**:
1. 紹介者が紹介リンクを発行・共有
2. 新規ユーザーが紹介リンク経由で登録ページにアクセス
3. 登録・決済完了後、Stripe Webhookが発火
4. Webhook処理で、紹介コードから紹介者を特定し、自動的に紹介レコードを作成
5. 紹介タイプは、**登録時点の被紹介者のロール**に基づいて決定されます
   - 登録時点で`MEMBER`ロール → `referralType = 'MEMBER'`（UGS会員紹介）
   - 登録時点で`FP`ロール → `referralType = 'FP'`（FPエイド紹介）

**注意事項**:
- 紹介リンク経由で登録するのは新規ユーザー（通常は`MEMBER`ロール）のみです
- FPエイドは既に会員であるため、紹介リンク経由で登録することはありません
- そのため、`referralType = 'FP'`になるケースは実質的にありません
- 紹介したUGSメンバーが後にFPエイドに昇格しても、紹介タイプは変更されません（登録時点のロールで固定）

#### 1.2 紹介コードの表示・共有
- **場所**: `/dashboard/referrals`
- **機能**:
  - ユーザーごとに自動生成された8文字の紹介コードを表示
  - 紹介リンク（`/register?ref={紹介コード}`）をクリップボードにコピー
  - 紹介コードを直接共有することも可能

#### 1.3 紹介統計の表示
以下の統計情報を表示します：
- **総紹介数**: これまでに紹介したメンバーの総数
- **UGS会員紹介数**: 一般会員として紹介した人数（`referralType = 'MEMBER'`）
- **FPエイド紹介数**: FPエイドとして紹介した人数（`referralType = 'FP'`）
  - **注意**: 現在の実装では、紹介リンク経由で登録するのは新規ユーザー（`MEMBER`）のみのため、この数値は通常0になります

#### 1.4 紹介一覧の表示
- 紹介したメンバーの一覧を表示
- 各紹介の情報：
  - 被紹介者の名前・メールアドレス
  - 紹介タイプ（UGS会員紹介 / FPエイド紹介）
  - ステータス（審査中 / 承認済み / 却下）
  - 紹介日時

#### 1.5 紹介の審査（管理者）
- **場所**: `/dashboard/admin/referrals`
- **機能**:
  - 全ユーザーの紹介一覧を表示
  - ステータス別にフィルタリング（審査中 / 承認済み / 却下 / すべて）
  - 各紹介の詳細情報を表示（紹介者、**入会者**、紹介タイプ、日時）
  - 紹介の承認・却下
  - 統計情報の表示（総紹介数、審査中、承認済み、却下、報酬支払済み）

**紹介ステータス**:
- **PENDING（審査中）**: 紹介レコード作成直後の初期状態。管理者による承認・却下待ち
- **APPROVED（承認済み）**: 管理者が承認した紹介。ユーザーの統計にカウントされる
- **REJECTED（却下）**: 管理者が却下した紹介。統計から除外される
- **REWARDED（報酬支払済み）**: 報酬が支払われた紹介（現在未使用）

**重要**: 紹介レコードは決済完了時に自動作成されますが、初期ステータスは**PENDING（審査中）**です。管理者が承認することで、初めてユーザーの統計にカウントされます。

**管理者画面の表示**: 管理者向け紹介管理画面では、被紹介者を「**入会者**」と表示しています。これはよりわかりやすい表現にするためです。

### 使い方

1. **紹介リンクを発行**
   - サイドバーから「紹介管理」をクリック
   - 画面上部に表示される紹介コードを確認
   - 「コピー」ボタンをクリックして紹介リンクをクリップボードにコピー
   - 紹介リンクの形式: `https://your-domain.com/register?ref={紹介コード}`

2. **紹介リンクを共有**
   - コピーした紹介リンクを新規ユーザーに共有（メール、SNS、メッセージなど）
   - または紹介コードを直接共有（新規ユーザーが手動でURLに追加）

3. **紹介の自動登録**
   - 新規ユーザーが紹介リンク経由で登録ページにアクセス
   - 登録フォームに入力して仮登録
   - 決済ページで決済を完了
   - 決済完了後、Stripe Webhookが自動的に紹介を登録
   - 紹介タイプは登録時点のロール（通常は`MEMBER`）で決定

4. **紹介の確認**
   - 「紹介一覧」で紹介状況を確認
   - 紹介統計で紹介実績を把握

5. **紹介の審査（管理者のみ）**
   - サイドバーから「紹介管理（管理者）」をクリック
   - 「審査中」タブで未承認の紹介を確認
   - 各紹介の詳細情報（紹介者、被紹介者、紹介タイプ、日時）を確認
   - 「承認」ボタンをクリックして紹介を承認
   - または「却下」ボタンをクリックして紹介を却下
   - 承認後、ユーザーの紹介統計に反映される

### APIエンドポイント

#### ユーザー向け:
- `GET /api/referrals?userId={userId}` - 紹介一覧を取得
- `POST /api/referrals` - 紹介を手動登録（通常は自動登録を使用）

#### 管理者向け:
- `GET /api/admin/referrals` - 全ユーザーの紹介一覧を取得（管理者のみ）
- `GET /api/admin/referrals?status={status}` - ステータスでフィルタリングして取得
- `POST /api/referrals/{referralId}/approve` - 紹介を承認（管理者）
- `POST /api/referrals/{referralId}/reject` - 紹介を却下（管理者）

#### 自動登録:
- `POST /api/referrals/register` - 紹介コードを使用して紹介を登録（Stripe Webhookから自動呼び出し）

**紹介の自動登録フロー**:
1. 新規ユーザーが紹介リンク（`/register?ref={紹介コード}`）経由で登録
2. 決済完了後、Stripe Webhook（`checkout.session.completed`）が発火
3. `handleReferralRegistration`関数が紹介コードを取得し、紹介者を特定
4. 被紹介者のロールに基づいて紹介タイプを決定
5. 紹介レコードを自動的に作成（`POST /api/referrals/register`相当の処理）

---

## 4. 契約管理機能

### 概要
FPエイド以上のユーザーが、保険契約などの契約実績を確認するための機能です。契約データは**管理者によるCSV一括アップロード**で登録されます。

### アクセス権限
- **契約の閲覧**: FPエイド（`fp`）、マネージャー（`manager`）、管理者（`admin`）
- **CSV一括アップロード**: 管理者（`admin`）のみ
- **アクセス不可**: 一般会員（`member`）

### 機能詳細

#### 4.1 契約情報
各契約には以下の情報が含まれます：
- **契約番号**: 契約を識別するための番号
- **商品名**: 契約商品の名称
- **契約タイプ**: 保険契約（`INSURANCE`）/ その他（`OTHER`）
- **契約日**: 契約を締結した日付
- **契約金額**: 契約の金額
- **報酬額**: 契約に対する報酬額
- **ステータス**: 有効（`ACTIVE`）/ 解約（`CANCELLED`）/ 期限切れ（`EXPIRED`）

#### 4.2 契約統計の表示
以下の統計情報を表示します：
- **有効契約数**: 現在有効な契約の数
- **総契約数**: 登録されている契約の総数
- **契約報酬合計**: 有効契約の報酬額の合計

#### 4.3 契約一覧の表示
- **場所**: `/dashboard/contracts`
- **表示内容**:
  - 自分の契約一覧（管理者はすべての契約を閲覧可能）
  - 契約番号、商品名、契約タイプ、契約日、金額、報酬額、ステータス
- **フィルタ機能**:
  - **ステータスフィルタ**: 全て / 有効 / 解約 / 期限切れ
  - **月別フィルタ**: 契約月（YYYY-MM形式）で絞り込み

### 使い方

1. **契約を確認**
   - サイドバーから「契約管理」をクリック
   - 契約一覧で自分の契約を確認
   - 統計情報で契約実績を把握
   - ステータスや月別フィルタで絞り込み

2. **契約の登録（管理者のみ）**
   - CSV一括アップロード機能を使用（詳細は「CSV一括アップロード機能」セクション参照）
   - 個別の手動登録は廃止されました

### APIエンドポイント

- `GET /api/contracts` - 契約一覧を取得
  - クエリパラメータ: `status` (ACTIVE/CANCELLED/EXPIRED), `month` (YYYY-MM形式)
- `GET /api/contracts/[contractId]` - 特定の契約を取得
- **CSV一括アップロード（管理者）:**
  - `POST /api/admin/contracts/upload/preview` - CSVデータのプレビュー
  - `POST /api/admin/contracts/upload/confirm` - CSV一括インポート

### データベースモデル
- `Contract` - 契約情報（契約番号、商品名、金額、報酬額、ステータス）

### 重要な変更点
- **手動登録機能は廃止**: 以前の「契約を追加」ボタンによる手動登録機能は削除されました
- **CSV一括アップロードのみ**: 管理者はCSVファイルで契約データを一括登録します

---

## 8. 昇格申請機能

### 概要
ユーザーが次のロールに昇格するための申請を行う機能です。

### アクセス権限
- **FPエイド昇格**: 一般会員（`member`）のみ
- **マネージャー昇格**: FPエイド（`fp`）のみ

### 機能詳細

#### 8.1 FPエイド昇格申請

**重要**: FPエイド昇格の3つの条件は**順番に解放される仕組み**です。次の条件は前の条件をクリアしないと表示されません。

**昇格条件（順番に解放）**:
1. **基礎編テスト合格** ← 最初から利用可能
2. **LP面談完了** ← テスト合格後に解放
3. **アンケート提出** ← LP面談完了後に解放

**詳細な申請フロー**:

##### ステップ1: 基礎編テストに合格（最初から利用可能）
- **場所**: `/dashboard/basic-test`
- **内容**: 10問のテスト（70%以上で合格）
- **再受験**: 合格するまで何度でも受験可能
- **合格後**: 自動的に条件が更新され、LP面談セクションが解放される

##### ステップ2: LP面談を完了（テスト合格後に解放）
- **場所**: `/dashboard/lp-meeting/request`
- **手順**:
  1. 希望日時を5つ選択して面談を申請
  2. 管理者がFPエイドを割り当てて面談を確定
  3. 確定した日時にオンライン面談を実施
  4. FPエイドが面談完了をマーク
- **完了後**: 自動的に条件が更新され、アンケートセクションが解放される

##### ステップ3: アンケートに回答（LP面談完了後に解放）
- **場所**: `/dashboard/survey`
- **内容**: 10設問のテキスト回答形式アンケート
- **再提出**: 不可（1回のみ提出可能）
- **提出後**: 自動的に条件が更新され、申請セクションが解放される

##### ステップ4: 昇格申請の準備と送信（3条件クリア後に解放）
3つの条件をすべてクリアすると、昇格申請セクションが表示されます。申請には以下が必要です：

1. **身分証のアップロード**（必須）
   - 運転免許証、パスポートなどの身分証明書
   - ファイル形式: JPEG、PNG、PDF
   - ファイルサイズ: 10MB以下
   - Supabase Storageに保存

2. **業務委託契約書への同意**（必須）
   - GMOサインの契約書URLを確認
   - 契約内容を確認後、同意チェックボックスにチェック

3. **昇格申請ボタンをクリック**
   - 身分証アップロードと契約同意が完了していることを確認
   - 「FPエイド昇格申請」ボタンをクリック

##### ステップ5: 審査
- 申請後、ステータスが「審査中（PENDING）」になる
- 画面上部に「審査中」バナーが表示される
- **注意**: 審査中は身分証アップロードと契約書セクションは非表示になる

##### ステップ6: 承認後
- 管理者が承認すると、ユーザーロールが自動的に`FP`に変更される
- 承認通知がメールとシステム通知で送信される
- ビデオガイダンスの視聴が必要（`fpOnboardingCompleted`がfalseに設定）
- **注意**: 承認後は身分証アップロードと契約書セクションが再表示される

#### 8.2 マネージャー昇格申請

**重要**: マネージャー昇格の4つの条件は**並列で評価**されます。すべての条件を同時に満たす必要があります。

**昇格条件（すべて必須）**:
1. **報酬実績**: 直近3ヶ月の平均報酬が**70,000円以上**
   - 計算対象: ステータスが`CONFIRMED`または`PAID`の報酬
   - 期間: 直近3ヶ月間の平均

2. **UGS会員紹介**: 6ヶ月間に**8名以上**のUGS会員を紹介
   - 計算対象: `referralType = 'MEMBER'`かつ`status = 'APPROVED'`の紹介
   - 期間: 直近6ヶ月間

3. **FPエイド紹介**: 6ヶ月間に**4名以上**のFPエイドを紹介
   - 計算対象: `referralType = 'FP'`かつ`status = 'APPROVED'`の紹介
   - 期間: 直近6ヶ月間

4. **契約実績**: **20件以上**の有効な保険契約を達成（直20被保）
   - 計算対象: `contractType = 'INSURANCE'`かつ`status = 'ACTIVE'`の契約
   - 件数: 累計20件以上

**申請フロー**:

##### ステップ1: 昇格条件の確認
- **場所**: `/dashboard/promotion`
- 各条件の達成状況が進捗バーで表示される
- リアルタイムで現在の数値と目標値を確認可能

##### ステップ2: 昇格申請の送信
- すべての条件を満たすと「マネージャー昇格を申請」ボタンが有効化
- ボタンをクリックして申請
- **注意**: FPエイド昇格と異なり、身分証アップロードや契約書への同意は不要

##### ステップ3: 審査
- 申請後、ステータスが「審査中（PENDING）」になる
- 管理者が条件を再確認

##### ステップ4: 承認後
- 管理者が承認すると、ユーザーロールが自動的に`MANAGER`に変更される
- 承認通知がメールとシステム通知で送信される

### 使い方

#### FPエイド昇格申請（MEMBERユーザー向け）

1. **昇格管理ページにアクセス**
   - サイドバーから「昇格管理」をクリック
   - FPエイド昇格セクションを確認

2. **3つの条件を順番にクリア**
   - **まず**: 基礎テストを受験して合格（70%以上）
   - **次に**: LP面談を予約・実施・完了
   - **最後に**: アンケートに回答・提出

3. **昇格申請**
   - 3条件クリア後、申請セクションが表示される
   - 身分証をアップロード
   - 業務委託契約書を確認して同意
   - 「FPエイド昇格申請」ボタンをクリック

4. **審査待ち**
   - 審査中バナーが表示される
   - 通知で審査結果が届く

5. **承認後**
   - FPエイドロールに自動変更
   - ビデオガイダンスの視聴が必要

#### マネージャー昇格申請（FPユーザー向け）

1. **昇格管理ページにアクセス**
   - サイドバーから「昇格管理」をクリック
   - マネージャー昇格セクションを確認

2. **4つの条件の達成状況を確認**
   - 報酬実績、会員紹介、FP紹介、契約実績の進捗を確認
   - すべての条件を満たすまで活動を継続

3. **昇格申請**
   - すべての条件達成後、「マネージャー昇格を申請」ボタンが有効化
   - ボタンをクリックして申請

4. **審査・承認**
   - 管理者が審査
   - 承認後、マネージャーロールに自動変更

### データベースモデル

#### FPエイド昇格申請
```prisma
model FPPromotionApplication {
  id                    String                       @id @default(cuid())
  userId                String                       @unique
  status                FPPromotionApplicationStatus @default(PENDING)
  lpMeetingCompleted    Boolean                      @default(false)
  basicTestCompleted    Boolean                      @default(false)
  surveyCompleted       Boolean                      @default(false)
  idDocumentUrl         String?
  promotionEmailSent    Boolean                      @default(false)
  promotionEmailSentAt  DateTime?
  appliedAt             DateTime                     @default(now())
  approvedAt            DateTime?
  completedAt           DateTime?
}

enum FPPromotionApplicationStatus {
  PENDING    // 審査中
  APPROVED   // 承認済み
  REJECTED   // 却下
  COMPLETED  // 完了
}
```

#### マネージャー昇格申請
```prisma
model PromotionApplication {
  id              String          @id @default(cuid())
  userId          String
  targetRole      UserRole        // FP or MANAGER
  status          PromotionStatus @default(PENDING)
  appliedAt       DateTime        @default(now())
  approvedAt      DateTime?
  rejectedAt      DateTime?
  rejectionReason String?
  reviewedAt      DateTime?
  reviewedBy      String?
  reviewNotes     String?

  @@unique([userId, targetRole])
}

enum PromotionStatus {
  PENDING    // 審査中
  APPROVED   // 承認済み
  REJECTED   // 却下
}
```

### APIエンドポイント

#### 昇格資格確認
- `GET /api/promotions/eligibility` - 昇格資格をチェック
  - クエリパラメータ: `targetRole` (FP or MANAGER)
  - レスポンス: 各条件の達成状況と総合判定

#### FPエイド昇格関連
- `POST /api/user/fp-promotion-apply` - FPエイド昇格申請を送信
- `GET /api/user/fp-promotion-application` - 自分のFP昇格申請情報を取得
- `POST /api/user/upload-id-document` - 身分証をアップロード（FP昇格用）
- `GET /api/user/get-id-document-url` - アップロードした身分証のURLを取得
- `GET /api/user/contract-url` - 業務委託契約書（GMOサイン）のURLを取得

#### マネージャー昇格関連
- `POST /api/promotions/apply` - マネージャー昇格申請を送信
  - リクエストボディ: `{ targetRole: "MANAGER" }`
- `GET /api/promotions/history` - 自分の昇格申請履歴を取得

#### 管理者向けAPI
- `GET /api/admin/promotions/fp` - FP昇格申請一覧を取得
- `GET /api/admin/promotions/manager` - マネージャー昇格申請一覧を取得
- `POST /api/admin/promotions/fp/[applicationId]/approve` - FP昇格申請を承認
- `POST /api/admin/promotions/fp/[applicationId]/reject` - FP昇格申請を却下
- `POST /api/admin/promotions/manager/[applicationId]/approve` - マネージャー昇格申請を承認
- `POST /api/admin/promotions/manager/[applicationId]/reject` - マネージャー昇格申請を却下

### 重要な注意事項

#### FPエイド昇格
- **順序厳守**: 基礎テスト → LP面談 → アンケートの順番で、前の条件をクリアしないと次が表示されない
- **身分証必須**: 申請時に身分証のアップロードが必須
- **契約書同意必須**: GMOサインの業務委託契約書への同意が必須
- **審査期間**: 申請後、管理者による審査に数日かかる場合がある
- **承認後**: ビデオガイダンスの視聴が必須（`fpOnboardingCompleted`がfalseに設定）
- **メール通知**: 承認時に自動でメール通知が送信される（重複送信防止機能あり）

#### マネージャー昇格
- **並列評価**: 4つの条件はすべて同時に満たす必要がある
- **自動計算**: 各条件の達成状況は自動的に計算される
- **書類不要**: FP昇格と異なり、身分証や契約書は不要
- **リアルタイム**: 進捗バーで常に現在の達成状況を確認可能

---

## 9. 基礎テスト機能

### 概要
FPエイド昇格の条件の一つである「基礎編テスト合格」を実現するため、メンバーが基礎編テストを受験する機能です。

### アクセス権限
- **アクセス可能**: 一般会員（`member`）のみ
- **アクセス不可**: FPエイド以上のロール

### 機能詳細

#### 5.1 テストの受験
- **問題数**: 10問
- **合格基準**: 70%以上（7問以上正解）
- **制限時間**: なし（時間制限なし）
- **再受験**: 合格するまで何度でも受験可能

#### 5.2 テスト結果の表示
- **スコア**: 得点率（%）を表示
- **合格/不合格**: 70%以上で合格
- **合格後**: 自動的に`FPPromotionApplication`の`basicTestCompleted`が更新される

### 使い方

1. **テストを受験**
   - サイドバーから「基礎テスト」をクリック（昇格管理ページからもアクセス可能）
   - または昇格管理ページの「テストを受ける」ボタンをクリック
   - 10問のテストに回答
   - 「テストを提出」ボタンをクリック

2. **結果を確認**
   - 提出後、スコアと合格/不合格が表示される
   - 合格した場合、昇格条件の「基礎編テスト合格」が自動的に完了になる
   - 不合格の場合、再度受験可能

### APIエンドポイント

- `GET /api/basic-test?userId={userId}` - テストとテスト結果を取得
- `POST /api/basic-test` - テストを提出
- `GET /api/admin/basic-test` - テストを管理（管理者）
- `POST /api/admin/basic-test` - テストを作成・更新（管理者）

---

## 10. アンケート機能

### 概要
FPエイド昇格の条件の一つである「アンケート提出」を実現するため、メンバーが初回アンケートに回答する機能です。

### アクセス権限
- **アクセス可能**: 一般会員（`member`）のみ
- **アクセス不可**: FPエイド以上のロール

### 機能詳細

#### 6.1 アンケートの回答
- **設問数**: 10設問
- **回答形式**: テキスト入力（textarea）
- **必須項目**: すべての設問が必須
- **再提出**: 提出後は再提出不可（1回のみ）

#### 6.2 アンケート提出の確認
- **提出後**: 自動的に`FPPromotionApplication`の`surveyCompleted`が更新される
- **提出済み**: 既に提出済みの場合は、提出済みである旨が表示される

### 使い方

1. **アンケートに回答**
   - サイドバーから「アンケート」をクリック（昇格管理ページからもアクセス可能）
   - または昇格管理ページの「アンケートに回答」ボタンをクリック
   - 10設問のアンケートに回答
   - 「アンケートを提出」ボタンをクリック

2. **提出を確認**
   - 提出後、昇格条件の「アンケート提出」が自動的に完了になる
   - 提出済みの場合は、再度回答することはできません

### APIエンドポイント

- `GET /api/survey?userId={userId}` - アンケートと提出状況を取得
- `POST /api/survey` - アンケートを提出
- `GET /api/admin/survey` - アンケートを管理（管理者）
- `POST /api/admin/survey` - アンケートを作成・更新（管理者）

---

## 5. 報酬管理機能

### 概要
FPエイド以上のユーザーが自分の報酬を確認し、管理者が全ユーザーの報酬を管理するための機能です。報酬データは**管理者によるCSV一括アップロードのみ**で登録されます。

### アクセス権限
- **報酬の閲覧**: FPエイド（`fp`）、マネージャー（`manager`）、管理者（`admin`）
- **報酬の管理・CSV一括アップロード**: 管理者（`admin`）のみ
- **アクセス不可**: 一般会員（`member`）

### 機能詳細

#### 5.1 報酬情報（ユーザー）
- **場所**: `/dashboard/compensation`
- **表示内容**:
  - 報酬サマリー:
    - 今月の報酬
    - 先月の報酬
    - 累計報酬（全期間合計）
    - 前月比トレンド
  - 月別フィルタ機能
  - 各報酬の詳細：
    - 対象月
    - 合計報酬額
    - 契約件数
    - 報酬の内訳：
      - UGS会員紹介報酬（memberReferral）
      - FPエイド紹介報酬（fpReferral）
      - 契約報酬（contract）
      - ボーナス（bonus）
  - **FPユーザー向け**: マネージャー昇格条件の進捗表示

**重要**: CSVアップロードされた報酬は全て**支払済み（PAID）**ステータスで登録されます。

#### 5.2 報酬管理（管理者）
- **場所**: `/dashboard/admin/compensations`
- **機能**:
  - 全ユーザーの報酬一覧を閲覧
  - 月別フィルタリング
  - CSV一括アップロードへのリンク

**報酬登録の流れ**:
1. 管理者が報酬データをCSV形式で準備
2. 「CSV一括アップロード」ボタンから一括アップロードページへ移動
3. CSVファイルをアップロードしてプレビュー確認
4. インポート実行で一括登録・更新（全て支払済みステータスで登録）

### 使い方

#### ユーザー（FP、マネージャー）

1. **報酬を確認**
   - サイドバーから「報酬管理」をクリック
   - サマリーカードで今月・先月・累計報酬を確認
   - 月別フィルタで特定月の報酬を絞り込み
   - 各報酬の詳細（対象月、金額、内訳）を確認

2. **昇格条件の確認（FPユーザーのみ）**
   - 報酬ページ下部のマネージャー昇格条件セクションを確認
   - 各条件の達成状況を進捗バーで確認

#### 管理者

1. **報酬一覧の確認**
   - サイドバーから「報酬管理（管理者）」をクリック
   - 全ユーザーの報酬一覧を確認
   - 月別フィルタで絞り込み

2. **CSV一括アップロード**
   - 「CSV一括アップロード」ボタンをクリック
   - `/dashboard/admin/csv-upload` ページへ移動
   - 詳細は「CSV一括アップロード機能」セクション参照

### APIエンドポイント

#### ユーザー向け:
- `GET /api/compensations` - 自分の報酬一覧と統計情報を取得
  - クエリパラメータ: `month` - 対象月フィルタ（YYYY-MM形式、任意）
  - レスポンス: 報酬一覧、統計情報（currentMonth, lastMonth, total, recentAverage, trend）

#### 管理者向け:
- `GET /api/admin/compensations` - 全ユーザーの報酬一覧を取得
  - クエリパラメータ: `month`, `status` - フィルタリング用（任意）
- **CSV一括アップロード:**
  - `POST /api/admin/compensations/upload/preview` - CSVデータのプレビュー
  - `POST /api/admin/compensations/upload/confirm` - CSV一括インポート（全て支払済みで登録）

### データベースモデル
```prisma
model Compensation {
  id            String
  userId        String
  month         String        // YYYY-MM形式
  amount        Int           // 合計報酬額
  contractCount Int           // 契約件数
  breakdown     Json          // 内訳 {memberReferral, fpReferral, contract, bonus, deduction}
  status        String        // 常に "PAID"
  createdAt     DateTime
  updatedAt     DateTime
}
```

### 重要な変更点
- **CSV一括アップロードのみ**: 報酬データの登録はCSV一括アップロードのみで行います
- **自動生成機能の廃止**: 月次報酬の自動生成機能は廃止されました
- **承認・支払いワークフローの廃止**: 報酬の承認・支払い管理機能は廃止されました
- **全て支払済みステータス**: CSVアップロードされた報酬は全て支払済み（PAID）ステータスで登録されます
- **累計報酬の計算**: ユーザー向けAPIで全報酬の合計を累計報酬として表示します

---

## 6. CSV一括アップロード機能

### 概要
管理者が契約データと報酬データをCSVファイルで一括登録・更新するための機能です。手動での個別登録に比べて、大量のデータを効率的に処理できます。

### アクセス権限
- **アクセス可能**: 管理者（`admin`）のみ

### 機能詳細

#### 6.1 統合CSVアップロードページ
- **場所**: `/dashboard/admin/csv-upload`
- **機能**: 契約と報酬の両方のCSVアップロードを一つのインターフェースで管理

#### 6.2 CSVアップロードの流れ

##### ステップ1: CSVファイルの準備
**契約データのCSV形式:**
```csv
userId,contractNumber,productName,amount,signedAt,status
user123,CON-2024-001,生命保険プランA,1000000,2024-01-15,ACTIVE
user456,CON-2024-002,医療保険プランB,500000,2024-01-20,ACTIVE
```

必須カラム:
- `userId`: ユーザーID
- `contractNumber`: 契約番号（ユニーク）
- `productName`: 商品名
- `amount`: 契約金額
- `signedAt`: 契約日（YYYY-MM-DD形式）
- `status`: ステータス（ACTIVE、CANCELLED、EXPIRED）

**報酬データのCSV形式:**
```csv
userId,month,totalAmount,baseAmount,bonusAmount,contractCount
user123,2024-01,500000,400000,100000,5
user456,2024-01,300000,250000,50000,3
```

必須カラム:
- `userId`: ユーザーID
- `month`: 対象月（YYYY-MM形式）
- `totalAmount`: 合計報酬額
- `baseAmount`: 基本報酬額
- `bonusAmount`: ボーナス額
- `contractCount`: 契約件数

##### ステップ2: プレビュー
1. CSVファイルをアップロード
2. システムがデータを解析し、以下を表示:
   - **追加（新規作成）**: 新しく作成されるレコード
   - **更新（既存の更新）**: 既存レコードの更新
   - **エラー**: データ検証エラー（例: 必須フィールドの欠落、無効な形式）
3. エラーがある場合は修正が必要

##### ステップ3: インポート確認
- プレビューを確認後、「インポート」ボタンをクリック
- データがデータベースに一括登録・更新される
- 成功・失敗の結果が表示される

#### 6.3 データ検証

以下の検証が自動的に行われます:
- **必須フィールドのチェック**: すべての必須カラムが存在するか
- **データ形式のチェック**: 日付、金額などが正しい形式か
- **ユーザー存在チェック**: 指定されたuserIdが存在するか
- **重複チェック**: 契約番号や月の重複をチェック

エラーがある行は、行番号とエラー内容が表示されます。

#### 6.4 アクセス方法

以下の複数の場所からアクセス可能:
1. **直接アクセス**: `/dashboard/admin/csv-upload`
2. **報酬管理ページから**: 「CSV一括アップロード」ボタン
3. **（将来的に）契約管理ページから**: 契約管理画面に追加予定

### 使い方

1. **CSVアップロードページにアクセス**
   - サイドバーから「管理者機能」→「CSV一括アップロード」をクリック
   - または報酬管理ページの「CSV一括アップロード」ボタンをクリック

2. **アップロードタイプを選択**
   - 「契約データ」または「報酬データ」を選択

3. **CSVファイルをアップロード**
   - 「ファイルを選択」ボタンでCSVファイルを選択
   - または、ドラッグ&ドロップでファイルをアップロード

4. **プレビューを確認**
   - 追加されるレコード数、更新されるレコード数を確認
   - エラーがある場合は、行番号とエラー内容を確認
   - 必要に応じてCSVファイルを修正して再アップロード

5. **インポートを実行**
   - エラーがない場合、「インポート」ボタンをクリック
   - 完了後、成功・失敗の件数が表示される

### APIエンドポイント

#### 契約データ:
- `POST /api/admin/contracts/upload/preview` - CSVデータのプレビュー
- `POST /api/admin/contracts/upload/confirm` - CSV一括インポート

#### 報酬データ:
- `POST /api/admin/compensations/upload/preview` - CSVデータのプレビュー
- `POST /api/admin/compensations/upload/confirm` - CSV一括インポート

### 注意事項

- **文字エンコーディング**: CSVファイルはUTF-8形式で保存してください
- **ファイルサイズ**: 大きなファイルは処理に時間がかかる場合があります
- **バックアップ**: インポート前に既存データのバックアップを推奨します
- **エラー処理**: エラーがある行はスキップされ、正常な行のみインポートされます
- **ロールバック**: インポート後の取り消しはできません（手動で削除・修正が必要）

### メリット

- **効率性**: 大量のデータを一度に登録・更新できる
- **正確性**: CSVファイルでデータを準備することで、入力ミスを減らせる
- **プレビュー機能**: 実行前に変更内容を確認できる
- **エラー検出**: データ検証により、問題を事前に発見できる

---

## 7. 通知機能

### 概要
システムからの重要な通知を受け取り、管理するための機能です。

### アクセス権限
- **アクセス可能**: すべてのロール（`member`, `fp`, `manager`, `admin`）

### 機能詳細

#### 7.1 通知の種類
以下の種類の通知があります：
- **昇格関連**: 昇格申請の承認・却下、昇格条件達成の通知
- **報酬関連**: 報酬の準備完了、報酬の支払い完了
- **イベント関連**: イベントのリマインダー、必須イベントの通知
- **紹介関連**: 紹介の承認・却下
- **契約関連**: 契約達成の通知
- **LP面談関連**: 面談の確定、完了の通知
- **その他**: アクションが必要な通知

#### 7.2 通知の優先度
- **重要（CRITICAL）**: 緊急の対応が必要な通知
- **情報（INFO）**: 一般的な情報通知
- **成功（SUCCESS）**: 成功を伝える通知

#### 7.3 通知の管理
- **未読/既読の管理**: 通知を個別に既読にする
- **一括既読**: すべての通知を一度に既読にする
- **通知の表示**: 未読通知と既読通知を分けて表示

### 使い方

1. **通知を確認**
   - サイドバーから「通知」をクリック
   - 未読通知が上部に表示される
   - 既読通知は下部に表示される

2. **通知を既読にする**
   - 個別に既読にする: 通知の右側のチェックボタンをクリック
   - 一括既読にする: 「すべて既読にする」ボタンをクリック

3. **通知の詳細を確認**
   - 通知に「詳細を見る」リンクがある場合、クリックして詳細ページに移動

### APIエンドポイント

- `GET /api/notifications` - 通知一覧を取得（ユーザーIDで自動フィルタリング）
- `POST /api/notifications` - 通知を作成（システム内部）
- `POST /api/notifications/[notificationId]/read` - 通知を既読にする
- `POST /api/notifications/mark-all-read` - すべての通知を既読にする

### データベースモデル
- `Notification` - 通知情報（タイプ、優先度、既読状態）

---

## 11. イベント管理機能

### 概要
イベントの作成・登録・管理を行う機能です。

### アクセス権限

#### 11.1 イベント参加（メンバー）
- **アクセス可能**: すべてのロール（`member`, `fp`, `manager`, `admin`）

#### 11.2 イベント管理（管理者）
- **アクセス可能**: 管理者（`admin`）のみ

### 機能詳細

#### 11.1 イベントの参加
- 開催予定のイベント一覧を表示
- イベントに参加登録・キャンセル
- イベントの詳細情報を確認

#### 11.2 イベントの作成・削除（管理者）
- 新しいイベントを作成
- イベントの情報を設定：
  - イベント名
  - 日時
  - **対象ロール**: UGS会員 / FPエイド / マネージャー / 全員（4つの選択肢から選択）
  - **参加設定**: 必須 / 任意（2つの選択肢から選択）
  - オンライン/オフライン
  - 場所
  - 最大参加者数
- イベントを削除

**イベントタイプの設定**:
- **対象ロール**: イベントに参加できるロールを指定します
  - **UGS会員**: UGS会員（`member`）のみが参加可能
  - **FPエイド**: FPエイド（`fp`）のみが参加可能
  - **マネージャー**: マネージャー（`manager`）のみが参加可能
  - **全員**: すべてのロールが参加可能
- **参加設定**: イベントへの参加が必須か任意かを設定します
  - **必須**: 対象ロールのユーザーは参加が必須（未参加の場合、警告や制限が発生する可能性）
  - **任意**: 対象ロールのユーザーは任意で参加可能

### 使い方

1. **イベントに参加（メンバー）**
   - サイドバーから「イベント」をクリック
   - 参加したいイベントの「参加登録」ボタンをクリック
   - キャンセルする場合は「キャンセル」ボタンをクリック

2. **イベントを作成（管理者）**
   - サイドバーから「イベント管理（管理者）」をクリック
   - 「イベントを作成」ボタンをクリック
   - イベント情報を入力：
     - イベント名、日時を入力
     - **対象ロール**を選択（UGS会員 / FPエイド / マネージャー / 全員）
     - **参加設定**を選択（必須 / 任意）
     - オンライン/オフライン、場所、最大参加者数を設定
   - 「作成」ボタンをクリック

3. **イベントを削除（管理者）**
   - イベント一覧から削除したいイベントの「削除」ボタンをクリック

### APIエンドポイント

- `GET /api/events` - イベント一覧を取得
- `POST /api/events/register` - イベントに参加登録・キャンセル
- `POST /api/admin/events` - イベントを作成（管理者）
- `DELETE /api/admin/events/[eventId]` - イベントを削除（管理者）

### データベースモデル
```prisma
model Event {
  id                String
  title             String
  description       String?
  date              DateTime
  time              String?
  type              EventType            @default(OPTIONAL)      // 後方互換性のため残す（非推奨）
  targetRoles       EventTargetRole[]                            // 対象ロール（複数選択可能）: MEMBER / FP / MANAGER / ALL
  attendanceType    EventAttendanceType  @default(OPTIONAL)      // 参加設定: REQUIRED / OPTIONAL
  venueType         EventVenueType       @default(ONLINE)        // 開催形式: ONLINE / OFFLINE / HYBRID
  location          String?
  maxParticipants   Int?
  currentParticipants Int               @default(0)
  createdAt         DateTime
  updatedAt         DateTime
}

model EventRegistration {
  id        String
  eventId   String
  userId    String
  status    String    // REGISTERED / CANCELLED
  createdAt DateTime
}
```

**重要**: `type`フィールドは後方互換性のために残されていますが、現在は`targetRoles`（対象ロール）と`attendanceType`（参加設定）の2つのフィールドで管理されています。

---

## 12. LP面談機能

### 概要
FPエイド昇格の条件の一つである「LP面談完了」を実現するため、FPエイドがメンバーとオンライン面談を行うための予約・管理システムです。

### アクセス権限

#### 9.1 面談予約申請（メンバー）
- **アクセス可能**: 一般会員（`member`）のみ

#### 9.2 面談管理（FPエイド）
- **アクセス可能**: FPエイド（`fp`）のみ

#### 9.3 面談管理（管理者）
- **アクセス可能**: 管理者（`admin`）のみ

### 機能詳細

#### 9.1 メンバー側: LP面談予約申請

**機能**:
- 面談希望日時の入力（**5つ選択**、必須）
- 要望・質問事項の入力（任意）
- 現在の予約状況の表示
- 予約申請の送信

**表示内容**:
- 現在の予約ステータス（未申請 / 申請中 / 予約済み / 完了）
- 申請中の場合: 申請した希望日時（5つ）
- 予約済みの場合: 確定日時、FPエイド名、オンライン面談のURL
- 完了の場合: 完了日時、FPエイドからのメモ

**フロー**:
1. メンバーが希望日時を5つ選択して申請
2. 運営側（管理者）に通知が送信される
3. 運営側が希望日時とFPエイドを選択して面談を確定
4. メンバーとFPエイドの両方に通知が送信される
5. 面談実施（オンライン）
6. FPエイドが面談完了を確認
7. `FPPromotionApplication`の`lpMeetingCompleted`が自動更新

#### 9.2 運営側（管理者）: LP面談管理

**機能**:
- 予約申請一覧の表示（ステータス: REQUESTED）
- 希望日時とFPエイドの選択
- オンライン面談URLの設定
- 面談の確定
- 全面談の一覧表示・管理
- 統計情報の表示

**表示内容**:
- 予約申請一覧（ステータス: REQUESTED）
- 各申請の詳細情報:
  - メンバー名・メールアドレス
  - 希望日時（5つ、選択可能）
  - 要望・質問事項
- 確定済み面談一覧
- 統計情報（申請数、確定数、完了数等）

**操作フロー**:
1. 申請をクリックして詳細を表示
2. 希望日時から1つを選択（ドロップダウン）
3. FPエイドを選択（ドロップダウン）
4. プラットフォームを選択（Zoom、Google Meet、Teams、その他）
5. オンライン面談URLを入力
6. 「面談を確定」ボタンをクリック

#### 9.3 FPエイド側: LP面談管理

**機能**:
- 確定された面談一覧の表示（自分の面談のみ）
- 面談の詳細確認
- 面談完了の確認
- 面談メモの記入

**表示内容**:
- 確定済み面談一覧（ステータス: SCHEDULED）
- 各面談の詳細情報:
  - メンバー名・メールアドレス
  - 面談日時
  - オンライン面談のURL
  - メンバーの要望・質問事項
- 完了済み面談一覧

### 使い方

1. **メンバー: LP面談予約申請**
   - サイドバーから「LP面談予約」をクリック
   - 希望日時を5つ選択（datetime-local入力）
   - 要望・質問事項を入力（任意）
   - 「面談予約を申請」ボタンをクリック

2. **管理者: 面談を確定**
   - サイドバーから「LP面談管理（管理者）」をクリック
   - 申請中の面談一覧から確定したい面談を選択
   - 希望日時から1つを選択
   - FPエイドを選択
   - プラットフォームを選択
   - オンライン面談URLを入力
   - 「面談を確定」ボタンをクリック

3. **FPエイド: 面談完了の確認**
   - サイドバーから「LP面談管理」をクリック
   - 予約済み面談一覧から完了した面談を選択
   - 「完了」ボタンをクリック
   - 面談メモを記入（任意）
   - 「面談完了を確認」ボタンをクリック

### APIエンドポイント

- `POST /api/lp-meetings/request` - 面談予約申請（メンバー）
- `GET /api/lp-meetings/request` - 自分の面談状況取得（メンバー、認証ユーザーのIDで自動取得）
- `GET /api/admin/lp-meetings` - 面談一覧取得（管理者）
- `POST /api/admin/lp-meetings/{meetingId}/schedule` - 面談を確定（管理者）
- `GET /api/lp-meetings/my-scheduled?fpId={fpId}` - 自分の面談一覧取得（FPエイド）
- `POST /api/lp-meetings/{meetingId}/complete` - 面談完了の確認（FPエイド）

**注意**: すべてのAPIエンドポイントは認証が必要です。認証トークンは`authenticatedFetch`を使用して自動的に送信されます。

---

## 17. パスワードリセット機能（旧セクション10）

### 概要
パスワードを忘れた場合に、メールアドレスを使用してパスワードをリセットする機能です。

### アクセス権限
- **アクセス可能**: すべてのユーザー（未ログイン状態）

### 機能詳細

#### 10.1 パスワードリセットの申請
- **場所**: `/forgot-password`
- **機能**:
  - 登録済みのメールアドレスを入力
  - パスワードリセットメールを送信
  - メール内のリンクからパスワードをリセット

#### 10.2 パスワードの再設定
- **場所**: `/reset-password`
- **機能**:
  - メール内のリンクからアクセス
  - 新しいパスワードを設定（6文字以上）
  - パスワード確認の入力
  - パスワードを更新

### 使い方

1. **パスワードリセットを申請**
   - ログインページの「パスワードを忘れた場合」リンクをクリック
   - または `/forgot-password` に直接アクセス
   - 登録済みのメールアドレスを入力
   - 「パスワードリセットメールを送信」ボタンをクリック

2. **メールを確認**
   - 送信されたメール内のリンクをクリック
   - リンクは1時間有効

3. **パスワードを再設定**
   - リセットページで新しいパスワードを入力（6文字以上）
   - パスワード確認を入力
   - 「パスワードを更新」ボタンをクリック
   - 更新後、自動的にログインページにリダイレクト

### 注意事項

- **リンクの有効期限**: パスワードリセットリンクは1時間有効です
- **同じパスワード**: 現在のパスワードと同じパスワードは設定できません
- **エラーメッセージ**: エラーメッセージは日本語で表示されます

### APIエンドポイント

- `POST /api/auth/reset-password` - パスワードリセットメールを送信

---

### ロール別アクセス権限一覧

| 機能 | member | fp | manager | admin |
|------|--------|----|---------|-------|
| 紹介管理 | ❌ | ✅ | ✅ | ✅ |
| 契約管理 | ❌ | ✅ | ✅ | ✅ |
| 通知 | ✅ | ✅ | ✅ | ✅ |
| FPエイド昇格申請 | ✅ | ❌ | ❌ | ❌ |
| マネージャー昇格申請 | ❌ | ✅ | ❌ | ❌ |
| 基礎テスト | ✅ | ❌ | ❌ | ❌ |
| アンケート | ✅ | ❌ | ❌ | ❌ |
| LP面談予約 | ✅ | ❌ | ❌ | ❌ |
| LP面談管理 | ❌ | ✅ | ❌ | ❌ |
| LP面談管理（管理者） | ❌ | ❌ | ❌ | ✅ |
| 報酬管理（管理者） | ❌ | ❌ | ❌ | ✅ |
| イベント参加 | ✅ | ✅ | ✅ | ✅ |
| イベント管理（管理者） | ❌ | ❌ | ❌ | ✅ |
| パスワードリセット | ✅ | ✅ | ✅ | ✅ |

### ナビゲーション

各機能へのアクセスは、サイドバーのナビゲーションメニューから行えます：

- **紹介管理**: `/dashboard/referrals`
- **契約管理**: `/dashboard/contracts`
- **通知**: `/dashboard/notifications`
- **昇格管理**: `/dashboard/promotion`
- **基礎テスト**: `/dashboard/basic-test`（メンバー）
- **アンケート**: `/dashboard/survey`（メンバー）
- **LP面談予約**: `/dashboard/lp-meeting/request`（メンバー）
- **LP面談管理**: `/dashboard/lp-meeting/manage`（FPエイド）
- **LP面談管理（管理者）**: `/dashboard/admin/lp-meetings`（管理者）
- **報酬管理（管理者）**: `/dashboard/admin/compensations`
- **イベント**: `/dashboard/events`
- **イベント管理（管理者）**: `/dashboard/admin/events`
- **パスワードリセット**: `/forgot-password`、`/reset-password`
- **設定**:
  - **プロフィール設定**: `/dashboard/settings/profile`
  - **アカウント設定**: `/dashboard/settings/account`
  - **セキュリティ設定**: `/dashboard/settings/security`
  - **通知設定**: `/dashboard/settings/notifications`
  - **サブスクリプション管理**: `/dashboard/settings/subscription`

### 注意事項

1. **紹介リンク発行形式**: 
   - 各ユーザーには自動的にユニークな8文字の紹介コードが生成されます。紹介コードは変更できません。
   - 紹介リンク（`/register?ref={紹介コード}`）を発行して新規ユーザーに共有することで、紹介を実施します。
   - 紹介リンク経由で登録・決済完了後、自動的に紹介が登録されます。
   - 紹介タイプは登録時点の被紹介者のロールで決定され、後から変更されることはありません。
   - 紹介したUGSメンバーが後にFPエイドに昇格しても、紹介タイプは`MEMBER`のままです。

2. **昇格申請**: 
   - FPエイド昇格申請には以下の条件が必要です：
     - 基礎編テスト合格（70%以上）
     - LP面談完了
     - アンケート提出
     - 身分証のアップロード（申請前のみ表示）
     - 業務委託契約書（GMOサイン）の締結（申請前のみ表示）
   - 申請後、審査中は身分証アップロードと業務委託契約書のセクションは非表示になります
   - 審査完了（承認）後は、これらのセクションが再表示されます
   - マネージャー昇格申請にはすべての条件を満たす必要があります

3. **報酬管理**: 
   - 報酬は管理者が月次で生成します
   - 報酬の承認・支払いは管理者が行います

4. **LP面談**: 
   - 面談はオンラインのみ対応
   - 希望日時は5つ選択する必要がある
   - 運営側が希望日時とFPエイドを選択して面談を確定
   - 面談完了後、FPエイド昇格の条件が自動的に更新される

5. **イベント**: 
   - イベントは対象ロール（UGS会員 / FPエイド / マネージャー / 全員）と参加設定（必須 / 任意）で分類されます
   - 必須イベントは対象ロールのユーザーにとって参加が必須です
   - 対象ロールに該当しないユーザーはイベントに参加できません

6. **サブスクリプション管理**: 
   - 決済失敗やキャンセル時はダッシュボードへのアクセスが制限されます
   - 設定ページは常にアクセス可能です
   - 管理者は常にアクセス可能です
   - カード情報の変更はStripe Customer Portalで行います

---

## 15. サブスクリプション管理機能（旧セクション11）

### 概要
ユーザーが自分のサブスクリプション（決済情報）を管理するための機能です。サブスクリプションの状態確認、カード情報の変更、キャンセル・再開、請求履歴の確認ができます。

### アクセス権限
- **アクセス可能**: すべての認証済みユーザー
- **アクセス不可**: 未認証ユーザー

### 機能詳細

#### 11.1 サブスクリプション情報の表示
- **場所**: `/dashboard/settings/subscription`
- **表示内容**:
  - **ステータス**: 有効、未払い、キャンセル済み
  - **月額料金**: ¥5,500
  - **現在の期間**: 開始日〜終了日
  - **次回請求日**: 次回の自動決済予定日
  - **登録カード情報**: カードブランド、下4桁、有効期限

#### 11.2 警告メッセージ
以下の場合に警告メッセージが表示されます：
- **決済失敗時**: 「決済が失敗しました。カード情報を更新して決済を完了してください。」
- **キャンセル予定時**: 「現在の期間終了時にサブスクリプションがキャンセルされます。」

#### 11.3 カード情報の変更
- **機能**: Stripe Customer Portalを使用したカード情報の更新
- **処理**:
  1. 「カード情報を変更」ボタンをクリック
  2. Stripe Customer Portalが開く
  3. カード情報を更新・追加
  4. 更新後、自動的にサブスクリプション管理ページに戻る

#### 11.4 サブスクリプションのキャンセル
- **機能**: サブスクリプションをキャンセル（期間終了時にキャンセル）
- **重要な注意点**:
  - **即時キャンセルではありません**: キャンセルを申請しても、現在の期間が終了するまでサービスを利用できます
  - **返金はありません**: 既に支払った料金の返金は行われません
  - **期間終了まで有効**: 次回請求日までダッシュボードや全機能にアクセス可能です
- **処理フロー**:
  1. 「キャンセル」ボタンをクリック
  2. 確認ダイアログで「現在の期間が終了するまでサービスをご利用いただけます」と表示
  3. キャンセルを確定すると、ステータスが「キャンセル予定」に変更される
  4. 画面上部に青色の警告バナーが表示される: 「サブスクリプションは現在の期間終了時にキャンセルされます」
  5. 現在の期間終了時（次回請求日）に自動的にキャンセルが実行される
  6. キャンセル実行時にキャンセル確認メールが送信される

**技術的な詳細**:
- キャンセル申請時は`cancel_at_period_end: true`がStripeに設定される
- データベースのステータス更新はStripe Webhook（`customer.subscription.deleted`）経由で行われる
- キャンセル申請直後はメールは送信されず、期間終了時のみメールが送信される

#### 11.5 サブスクリプションの再開
- **機能**: キャンセル予定のサブスクリプションを再開
- **処理**:
  1. キャンセル予定の場合、「サブスクリプションを再開」ボタンが表示される
  2. ボタンをクリックすると即座にキャンセル予定がキャンセルされる
  3. 通常の有効なサブスクリプションに戻る
  4. 次回請求日が維持される

#### 11.6 請求履歴の表示
- **機能**: 過去の請求書一覧を表示
- **表示内容**:
  - 請求期間（開始日〜終了日）
  - 請求金額
  - ステータス（支払済み、未払い、無効）
  - 請求書PDFへのリンク
- **表示件数**: 最大12件（直近）

### 使い方

1. **サブスクリプション管理ページにアクセス**
   - サイドバーから「設定」をクリック
   - 「サブスクリプション管理」をクリック

2. **サブスクリプション情報を確認**
   - 現在のステータス、月額料金、期間を確認
   - 登録されているカード情報を確認

3. **カード情報を変更**
   - 「カード情報を変更」ボタンをクリック
   - Stripe Customer Portalでカード情報を更新

4. **サブスクリプションをキャンセル**
   - 「キャンセル」ボタンをクリック
   - 確認ダイアログで「OK」をクリック
   - 現在の期間終了時にキャンセルされる

5. **サブスクリプションを再開**
   - キャンセル予定の場合、「サブスクリプションを再開」ボタンをクリック
   - 即座に再開される

6. **請求履歴を確認**
   - 「請求履歴」セクションで過去の請求書を確認
   - 「請求書を見る」ボタンでPDFを表示

### アクセス制限について

以下の状態の場合、ダッシュボードへのアクセスが制限されます：
- **未払い（PAST_DUE）**: 決済が失敗した場合
- **未払い（UNPAID）**: 決済が完了していない場合
- **キャンセル済み（CANCELED）**: サブスクリプションがキャンセルされた場合

制限された場合：
- アクセス制限の警告画面が表示される
- サブスクリプション管理ページへのリンクが表示される
- 設定ページ（`/dashboard/settings/*`）は常にアクセス可能
- 管理者は常にアクセス可能

### メール通知

以下の場合にメール通知が送信されます：
- **決済失敗時**: カード情報更新への案内メール
- **キャンセル時**: キャンセル確認と再開への案内メール

### APIエンドポイント

- `GET /api/user/subscription` - サブスクリプション情報を取得
- `POST /api/user/subscription/cancel` - サブスクリプションをキャンセル
- `POST /api/user/subscription/reactivate` - サブスクリプションを再開
- `POST /api/user/subscription/update-payment-method` - カード情報更新用のCustomer Portalセッションを作成
- `GET /api/user/subscription/invoices` - 請求履歴を取得

### 注意事項

- **キャンセルは即時ではありません**: キャンセル申請後も現在の期間が終了するまでサービスを利用できます
- **返金なし**: キャンセル時の返金は一切行われません。次回請求日までの料金は支払い済みです
- **再開可能**: 期間終了前であれば、いつでもキャンセルを取り消して再開できます
- カード情報の変更はStripe Customer Portalで行います
- 決済失敗が続く場合、サービスへのアクセスが制限される可能性があります
- 請求履歴は最大12件まで表示されます

---

## 14. 動画ガイダンス機能

### 概要
各ロール（UGS会員、FPエイド、マネージャー）ごとに、それぞれのロールに応じた動画ガイダンスを用意しています。ロールに応じた動画ガイダンスを視聴することで、各ロールとしての活動を開始する前に必要な知識を習得できます。動画の90%以上を視聴することで完了となります。

### アクセス権限

#### 12.1 UGS会員向け動画ガイダンス
- **対象**: UGS会員（`member`）で、動画ガイダンス未完了のユーザー
- **場所**: `/dashboard/member-onboarding`
- **自動リダイレクト**: 未完了のUGS会員がダッシュボードにアクセスすると、自動的に動画ガイダンスページにリダイレクトされます

#### 12.2 FPエイド向け動画ガイダンス
- **対象**: FPエイド（`fp`）で、動画ガイダンス未完了のユーザー
- **場所**: `/dashboard/fp-onboarding`
- **自動リダイレクト**: 未完了のFPエイドがダッシュボードにアクセスすると、自動的に動画ガイダンスページにリダイレクトされます

#### 12.3 マネージャー向け動画ガイダンス
- **対象**: マネージャー（`manager`）で、動画ガイダンス未完了のユーザー
- **場所**: `/dashboard/manager-onboarding`
- **自動リダイレクト**: 未完了のマネージャーがダッシュボードにアクセスすると、自動的に動画ガイダンスページにリダイレクトされます

### 機能詳細

#### 12.4 動画ガイダンスの表示
- **機能**:
  - Vimeo動画プレイヤーを使用した動画再生
  - 視聴進捗のリアルタイム表示（0-100%）
  - 90%以上視聴で自動的に完了処理を実行
  - 動画終了時にも完了処理を実行
  - 各ロールごとに異なる動画コンテンツを表示

#### 12.5 アクセス制限
動画ガイダンス未完了のユーザーは、以下の機能にアクセスできません：
- ダッシュボード（動画ガイダンスページにリダイレクト）
- ロール固有の機能（紹介管理、契約管理など）
- その他の主要機能

### 使い方

1. **ロール昇格後の自動リダイレクト**
   - UGS会員登録時、FPエイド昇格時、マネージャー昇格時に、それぞれの動画ガイダンス完了フラグが`false`に設定される
   - 次回ログイン時、またはダッシュボードにアクセスすると、自動的に該当する動画ガイダンスページにリダイレクトされる

2. **動画の視聴**
   - 動画ガイダンスページで動画を再生
   - 視聴進捗がリアルタイムで表示される
   - 90%以上視聴すると自動的に完了処理が実行される

3. **完了後の動作**
   - 動画ガイダンス完了後、通常の機能にアクセス可能になる
   - 次回以降は動画ガイダンスページにリダイレクトされない

### APIエンドポイント

- `GET /api/user/member-onboarding-status` - UGS会員向け動画ガイダンスの完了状況を取得
- `POST /api/user/member-onboarding/complete` - UGS会員向け動画ガイダンスの視聴完了を記録
- `GET /api/user/fp-onboarding-status` - FPエイド向け動画ガイダンスの完了状況を取得
- `POST /api/user/fp-onboarding/complete` - FPエイド向け動画ガイダンスの視聴完了を記録
- `GET /api/user/manager-onboarding-status` - マネージャー向け動画ガイダンスの完了状況を取得
- `POST /api/user/manager-onboarding/complete` - マネージャー向け動画ガイダンスの視聴完了を記録

### セキュリティ対策

- **フロントエンド**: 各ロール用の`OnboardingGuard`コンポーネントで画面遷移を制御
- **バックエンド**: 各ロール機能のAPIでオンボーディング完了状況をチェック
- **抜け道防止**: クライアント側だけでなく、API側でもチェックを実装

### 注意事項

- 各ロールごとに異なる動画URLを設定します（環境変数で設定）
  - UGS会員: `NEXT_PUBLIC_MEMBER_ONBOARDING_VIMEO_ID`
  - FPエイド: `NEXT_PUBLIC_FP_ONBOARDING_VIMEO_ID`
  - マネージャー: `NEXT_PUBLIC_MANAGER_ONBOARDING_VIMEO_ID`
- 既存ユーザーは自動的に完了済みとして扱われます（デフォルト値: `true`）
- 新規登録時やロール昇格時のみ、動画ガイダンスが必須となります

---

## 13. チーム管理機能

### 概要
マネージャー以上のユーザーが、自分が紹介したチームメンバーの情報や活動状況を確認するための機能です。

### アクセス権限
- **アクセス可能**: マネージャー（`manager`）、管理者（`admin`）
- **アクセス不可**: 一般会員（`member`）、FPエイド（`fp`）

### 機能詳細

#### 13.1 チームメンバー一覧
- **場所**: `/dashboard/team`
- **表示内容**:
  - 自分が紹介したメンバーの一覧
  - 各メンバーの情報:
    - 名前・メールアドレス
    - 現在のロール（UGS会員、FPエイド、マネージャー）
    - サブスクリプション状態（有効、キャンセル済み、未払い）
    - 学習進捗（レッスン完了数）
    - 紹介タイプ（UGS会員紹介、FPエイド紹介）

#### 13.2 チーム統計
以下の統計情報を表示します：
- **総メンバー数**: 紹介したメンバーの総数
- **アクティブメンバー数**: サブスクリプションが有効なメンバー数
- **平均レッスン完了数**: チーム全体の平均学習進捗
- **契約数**: チーム全体の契約数（FPエイド以上のメンバー）
- **ロール別内訳**: UGS会員、FPエイド、マネージャーの人数
- **紹介タイプ別内訳**: UGS会員紹介、FPエイド紹介の人数

### 使い方

1. **チーム管理ページにアクセス**
   - サイドバーから「チーム管理」をクリック（マネージャー以上のみ表示）

2. **チーム統計を確認**
   - ページ上部でチーム全体の統計を確認
   - アクティブメンバー数や学習進捗を把握

3. **メンバー詳細を確認**
   - メンバー一覧で個別のメンバー情報を確認
   - ロールやサブスクリプション状態を把握

### APIエンドポイント

- `GET /api/team/members` - チームメンバー一覧を取得
- `GET /api/team/stats` - チーム統計を取得

### データベースモデル
- `Referral` - 紹介関係を使用してチーム階層を構築

### 注意事項

- 紹介関係に基づいてチームメンバーが表示されます
- マネージャー以上のロールのみアクセス可能です
- メンバーのプライバシーに配慮した情報のみが表示されます

---

---

## 16. プロフィール・アカウント設定

### 概要
ユーザーが自分のプロフィール情報やアカウント設定を管理するための機能です。

### アクセス権限
- **アクセス可能**: すべての認証済みユーザー

### 機能詳細

#### 16.1 プロフィール設定
- **場所**: `/dashboard/settings/profile`
- **設定項目**:
  - 名前（姓・名）
  - プロフィール画像
  - 電話番号
  - 業種（industry）- 以下から選択:
    - 金融・保険業
    - 不動産業
    - 税理士・会計士
    - コンサルティング業
    - IT・通信業
    - 製造業
    - 卸売・小売業
    - 医療・福祉
    - 教育・学習支援業
    - サービス業
    - 建設業
    - 運輸業
    - 公務員
    - 学生
    - その他
  - 活動地域（都道府県）
  - 住所
  - 生年月日
  - 性別（男性・女性・その他・回答しない）
  - 自己紹介（bio）

#### 16.2 アカウント設定
- **場所**: `/dashboard/settings/account`
- **設定項目**:
  - メールアドレスの確認
  - アカウント削除リクエスト

#### 16.3 セキュリティ設定
- **場所**: `/dashboard/settings/security`
- **設定項目**:
  - パスワード変更

#### 16.4 通知設定
- **場所**: `/dashboard/settings/notifications`
- **設定項目**:
  - **メール通知**: 重要な通知をメールで受信する設定
  - **イベント通知**: イベントのリマインダー通知
  - **教育コンテンツ更新通知**: 新しい教育コンテンツの追加通知
  - **昇格通知**: 昇格に関する通知

### 使い方

1. **プロフィール情報の更新**
   - サイドバーから「設定」→「プロフィール」をクリック
   - 各項目を入力・更新
   - 「保存」ボタンをクリック

2. **プロフィール画像の変更**
   - プロフィール設定ページで画像をアップロード
   - プレビューを確認して保存

3. **パスワードの変更**
   - 「設定」→「セキュリティ」をクリック
   - 現在のパスワードと新しいパスワードを入力
   - 「変更」ボタンをクリック

4. **通知設定の管理**
   - 「設定」→「通知設定」をクリック
   - 各種通知のオン/オフを切り替え
   - 設定は自動的に保存される

### APIエンドポイント

- `GET /api/auth/profile/[userId]` - ユーザープロフィールを取得
- `POST /api/user/update-profile` - プロフィールを更新
- `POST /api/user/cancel-request` - アカウント削除をリクエスト
- `GET /api/user/notification-preferences` - 通知設定を取得
- `POST /api/user/notification-preferences` - 通知設定を更新

### データベースモデル
- `User` - ユーザー情報（プロフィール、アカウント情報）
- `CancelRequest` - アカウント削除リクエスト

### 注意事項

- プロフィール画像はSupabase Storageに保存されます
- アカウント削除リクエストは管理者による承認が必要です
- 設定ページはサブスクリプション状態に関わらずアクセス可能です

---

## 18. 管理者機能

### 概要
管理者が全ユーザーの管理、システム設定、データ管理を行うための統合管理機能です。

### アクセス権限
- **アクセス可能**: 管理者（`admin`）のみ

### 機能詳細

#### 18.1 ユーザー管理
- **場所**: `/dashboard/admin/users`
- **機能**:
  - 全ユーザーの一覧表示
  - ユーザーのロール変更
  - ユーザー検索・フィルタリング
  - 保留中の登録の管理

#### 18.2 アナリティクスダッシュボード
- **場所**: `/dashboard/analytics`（管理者のみ）
- **表示内容**:
  - アクティブ会員数
  - 月次収益（会員数 × ¥5,500）
  - キャンセル数
  - 定着率（Retention Rate）
  - リアルタイムのStripe統合データ

#### 18.3 昇格申請管理
- **場所**: `/dashboard/admin/promotions`
- **機能**:
  - FP昇格申請の承認・却下
  - マネージャー昇格申請の承認・却下
  - 身分証確認
  - 契約書確認

#### 18.4 CSV一括アップロード
- **場所**: `/dashboard/admin/csv-upload`
- **機能**:
  - 契約データの一括登録・更新
  - 報酬データの一括登録・更新
  - プレビュー機能
  - エラー検証

#### 18.5 資料管理
- **機能**:
  - 資料のアップロード（Supabase Storage）
  - 資料の編集・削除
  - 閲覧可能ロールの設定

#### 18.6 その他の管理機能
- 報酬管理: 報酬の生成、承認、支払い管理
- イベント管理: イベントの作成・削除
- LP面談管理: 面談の確定・管理
- サブスクリプション管理: 全ユーザーのサブスクリプション状況確認

### 使い方

1. **ユーザー管理**
   - サイドバーから「ユーザー管理」をクリック
   - ユーザーを検索・フィルタリング
   - ロールを変更する場合、ユーザーを選択して新しいロールを設定

2. **アナリティクスの確認**
   - サイドバーから「アナリティクス」をクリック
   - リアルタイムの統計情報を確認

3. **昇格申請の承認**
   - サイドバーから「昇格申請管理」をクリック
   - 申請を確認して承認または却下

### APIエンドポイント

#### ユーザー管理:
- `GET /api/admin/users` - 全ユーザーを取得
- `GET /api/admin/pending-users` - 保留中の登録を取得
- `POST /api/admin/users/role` - ユーザーのロールを更新

#### アナリティクス:
- `GET /api/admin/subscriptions` - サブスクリプション統計を取得

#### その他:
- 各機能の管理者専用エンドポイント（詳細は各セクション参照）

### 注意事項

- 管理者機能は強力な権限を持つため、慎重に使用してください
- ユーザーのロール変更は重要な操作です。誤って変更しないよう注意してください
- CSV一括アップロードは大量のデータを変更するため、事前にバックアップを推奨します

---

## 🔗 関連ドキュメント

- [テストガイド](./TEST-GUIDE.md) - 機能のテスト方法
- [実装サマリー](./IMPLEMENTATION-SUMMARY.md) - 実装の詳細
- [FPエイド向け動画ガイダンス実装詳細](./FP-ONBOARDING-IMPLEMENTATION.md) - FPエイド向け動画ガイダンス機能の詳細
- [README](./README.md) - プロジェクトの概要

---

**最終更新**: 2025年12月

