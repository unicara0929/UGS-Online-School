# UGSオンラインスクール 機能ガイド

このドキュメントでは、UGSオンラインスクールに実装されているすべての機能とその使い方を説明します。

---

## 📋 目次

1. [紹介管理機能](#紹介管理機能)
2. [契約管理機能](#契約管理機能)
3. [通知機能](#通知機能)
4. [昇格申請機能](#昇格申請機能)
5. [報酬管理機能（管理者）](#報酬管理機能管理者)
6. [イベント管理機能](#イベント管理機能)
7. [LP面談機能](#lp面談機能)

---

## 1. 紹介管理機能

### 概要
FPエイド以上のユーザーが、新しいメンバーを紹介し、紹介報酬を管理するための機能です。

### アクセス権限
- **アクセス可能**: FPエイド（`fp`）、マネージャー（`manager`）、管理者（`admin`）
- **アクセス不可**: 一般会員（`member`）

### 機能詳細

#### 1.1 紹介コードの表示・共有
- **場所**: `/dashboard/referrals`
- **機能**:
  - ユーザーごとに自動生成された8文字の紹介コードを表示
  - 紹介リンク（`/register?ref={紹介コード}`）をクリップボードにコピー
  - 紹介コードを直接共有することも可能

#### 1.2 紹介統計の表示
以下の統計情報を表示します：
- **総紹介数**: これまでに紹介したメンバーの総数
- **UGS会員紹介数**: 一般会員として紹介した人数
- **FPエイド紹介数**: FPエイドとして紹介した人数
- **総報酬額**: 承認済みの紹介報酬の合計額

#### 1.3 紹介一覧の表示
- 紹介したメンバーの一覧を表示
- 各紹介の情報：
  - 被紹介者の名前・メールアドレス
  - 紹介タイプ（UGS会員紹介 / FPエイド紹介）
  - ステータス（審査中 / 承認済み / 却下 / 報酬支払済み）
  - 報酬額
  - 紹介日時

### 使い方

1. **紹介コードを取得**
   - サイドバーから「紹介管理」をクリック
   - 画面上部に表示される紹介コードを確認
   - 「コピー」ボタンをクリックして紹介リンクをコピー

2. **紹介リンクを共有**
   - コピーした紹介リンクを新規ユーザーに共有
   - または紹介コードを直接共有

3. **紹介の確認**
   - 新規ユーザーが紹介リンク経由で登録・決済完了後、自動的に紹介が登録される
   - 「紹介一覧」で紹介状況を確認

4. **紹介の審査**
   - 管理者が紹介を承認または却下（管理者機能）
   - 承認時に報酬額が設定される

### APIエンドポイント

- `GET /api/referrals?userId={userId}` - 紹介一覧を取得
- `POST /api/referrals` - 紹介を登録（通常は自動）
- `POST /api/referrals/{referralId}/approve` - 紹介を承認（管理者）
- `POST /api/referrals/{referralId}/reject` - 紹介を却下（管理者）
- `POST /api/referrals/register` - 紹介コードを使用して紹介を登録

---

## 2. 契約管理機能

### 概要
FPエイド以上のユーザーが、保険契約などの契約実績を登録・管理するための機能です。

### アクセス権限
- **アクセス可能**: FPエイド（`fp`）、マネージャー（`manager`）、管理者（`admin`）
- **アクセス不可**: 一般会員（`member`）

### 機能詳細

#### 2.1 契約の登録
以下の情報を入力して契約を登録できます：
- **契約番号**: 契約を識別するための番号（必須）
- **契約タイプ**: 保険契約 / その他（必須）
- **契約日**: 契約を締結した日付（必須）
- **契約金額**: 契約の金額（任意）

#### 2.2 契約統計の表示
以下の統計情報を表示します：
- **有効契約数**: 現在有効な契約の数
- **総契約数**: 登録されている契約の総数
- **契約報酬合計**: 有効契約の報酬額の合計

#### 2.3 契約一覧の表示
- 登録した契約の一覧を表示
- 各契約の情報：
  - 契約番号
  - 契約タイプ
  - 契約日
  - 契約金額
  - 報酬額（設定されている場合）
  - ステータス（有効 / 解約 / 期限切れ）

### 使い方

1. **契約を登録**
   - サイドバーから「契約管理」をクリック
   - 「契約を追加」ボタンをクリック
   - 契約情報を入力して「登録」ボタンをクリック

2. **契約を確認**
   - 「契約一覧」で登録した契約を確認
   - 統計情報で契約実績を把握

3. **契約を更新・削除**
   - 管理者が契約情報を更新・削除可能（管理者機能）

### APIエンドポイント

- `GET /api/contracts?userId={userId}` - 契約一覧を取得
- `POST /api/contracts` - 契約を登録
- `PUT /api/contracts/{contractId}` - 契約を更新（管理者）
- `DELETE /api/contracts/{contractId}` - 契約を削除（管理者）

---

## 3. 通知機能

### 概要
システムからの重要な通知を受け取り、管理するための機能です。

### アクセス権限
- **アクセス可能**: すべてのロール（`member`, `fp`, `manager`, `admin`）

### 機能詳細

#### 3.1 通知の種類
以下の種類の通知があります：
- **昇格関連**: 昇格申請の承認・却下、昇格条件達成の通知
- **報酬関連**: 報酬の準備完了、報酬の支払い完了
- **イベント関連**: イベントのリマインダー、必須イベントの通知
- **紹介関連**: 紹介報酬の支払い完了
- **契約関連**: 契約達成の通知
- **その他**: アクションが必要な通知

#### 3.2 通知の優先度
- **重要（CRITICAL）**: 緊急の対応が必要な通知
- **情報（INFO）**: 一般的な情報通知
- **成功（SUCCESS）**: 成功を伝える通知

#### 3.3 通知の管理
- **未読/既読の管理**: 通知を個別に既読にする
- **一括既読**: すべての通知を一度に既読にする
- **通知の表示**: 未読通知と既読通知を分けて表示

### 使い方

1. **通知を確認**
   - サイドバーから「通知」をクリック
   - 未読通知が上部に表示される
   - 既読通知は下部に表示される

2. **通知を既読にする**
   - 個別に既読にする: 通知の右側のチェックボタンをクリック
   - 一括既読にする: 「すべて既読にする」ボタンをクリック

3. **通知の詳細を確認**
   - 通知に「詳細を見る」リンクがある場合、クリックして詳細ページに移動

### APIエンドポイント

- `GET /api/notifications?userId={userId}` - 通知一覧を取得
- `POST /api/notifications` - 通知を作成（システム内部）
- `POST /api/notifications/{notificationId}/read` - 通知を既読にする
- `POST /api/notifications/mark-all-read` - すべての通知を既読にする

---

## 4. 昇格申請機能

### 概要
ユーザーが次のロールに昇格するための申請を行う機能です。

### アクセス権限
- **FPエイド昇格**: 一般会員（`member`）のみ
- **マネージャー昇格**: FPエイド（`fp`）のみ

### 機能詳細

#### 4.1 FPエイド昇格申請

**昇格条件**:
1. 基礎編テスト合格: 3カテゴリの基礎編テストに合格する
2. LP面談完了: ライフプランナーとの面談を完了する
3. アンケート提出: 初回アンケートを提出する

**申請手順**:
1. 身分証のアップロード
   - 運転免許証、パスポートなどの身分証の画像をアップロード
   - ファイル形式: JPEG、PNG、PDF
   - ファイルサイズ: 10MB以下
2. 昇格申請の送信
   - すべての条件を満たし、身分証をアップロードした後、「FPエイド昇格申請」ボタンをクリック

#### 4.2 マネージャー昇格申請

**昇格条件**:
1. 報酬実績: 直近3ヶ月の平均報酬が一定額以上
2. UGS会員紹介: 6ヶ月間に一定数のUGS会員を紹介
3. FPエイド紹介: 6ヶ月間に一定数のFPエイドを紹介
4. 契約実績: 直近20件の保険契約を達成

**申請手順**:
1. 昇格可能性の確認
   - 「昇格管理」ページで各条件の達成状況を確認
   - 進捗バーで各条件の達成度を視覚的に確認
2. 昇格申請の送信
   - すべての条件を満たした後、「マネージャー昇格を申請」ボタンをクリック

### 使い方

1. **FPエイド昇格申請**
   - サイドバーから「昇格管理」をクリック
   - 昇格条件の達成状況を確認
   - 身分証をアップロード
   - 「FPエイド昇格申請」ボタンをクリック

2. **マネージャー昇格申請**
   - サイドバーから「昇格管理」をクリック
   - 昇格条件の達成状況を確認
   - 「マネージャー昇格を申請」ボタンをクリック

3. **申請状況の確認**
   - 申請後、管理者による審査が行われます
   - 審査結果は通知でお知らせします

### APIエンドポイント

- `GET /api/promotions/eligibility?userId={userId}&targetRole={role}` - 昇格可能性をチェック
- `POST /api/promotions/apply` - 昇格申請を送信
- `POST /api/user/upload-id-document` - 身分証をアップロード（FP昇格用）
- `GET /api/user/get-id-document-url?userId={userId}` - アップロードした身分証のURLを取得
- `POST /api/admin/promotions/{applicationId}/approve` - 昇格申請を承認（管理者）
- `POST /api/admin/promotions/{applicationId}/reject` - 昇格申請を却下（管理者）

---

## 5. 報酬管理機能（管理者）

### 概要
管理者が全ユーザーの月次報酬を生成・承認・支払い管理するための機能です。

### アクセス権限
- **アクセス可能**: 管理者（`admin`）のみ
- **アクセス不可**: その他のすべてのロール

### 機能詳細

#### 5.1 月次報酬の生成
- 指定した月の報酬を自動計算して生成
- 報酬の内訳：
  - UGS会員紹介報酬
  - FPエイド紹介報酬
  - 契約報酬
  - ボーナス
  - 控除

#### 5.2 報酬の承認
- 生成された報酬を確認し、承認する
- 承認後、ユーザーに通知が送信される

#### 5.3 報酬の支払い管理
- 承認済みの報酬を支払い済みとしてマーク
- 支払い完了後、ユーザーに通知が送信される

### 使い方

1. **報酬を生成**
   - サイドバーから「報酬管理（管理者）」をクリック
   - 「報酬を生成」ボタンをクリック
   - 対象月（YYYY-MM形式）を入力
   - 「報酬を生成」ボタンをクリック

2. **報酬を承認**
   - 生成された報酬一覧を確認
   - 各報酬の「承認」ボタンをクリック

3. **報酬を支払い済みにする**
   - 承認済みの報酬の「支払済み」ボタンをクリック
   - 支払い完了後、ステータスが「支払済み」に更新される

### APIエンドポイント

- `POST /api/admin/compensations/generate` - 月次報酬を生成
- `POST /api/admin/compensations/{compensationId}/approve` - 報酬を承認
- `POST /api/admin/compensations/{compensationId}/pay` - 報酬を支払い済みにする

---

## 6. イベント管理機能

### 概要
イベントの作成・登録・管理を行う機能です。

### アクセス権限

#### 6.1 イベント参加（メンバー）
- **アクセス可能**: すべてのロール（`member`, `fp`, `manager`, `admin`）

#### 6.2 イベント管理（管理者）
- **アクセス可能**: 管理者（`admin`）のみ

### 機能詳細

#### 6.1 イベントの参加
- 開催予定のイベント一覧を表示
- イベントに参加登録・キャンセル
- イベントの詳細情報を確認

#### 6.2 イベントの作成・削除（管理者）
- 新しいイベントを作成
- イベントの情報を設定：
  - イベント名
  - 日時
  - イベントタイプ（必須 / 任意 / マネージャーのみ）
  - オンライン/オフライン
  - 場所
  - 最大参加者数
- イベントを削除

### 使い方

1. **イベントに参加（メンバー）**
   - サイドバーから「イベント」をクリック
   - 参加したいイベントの「参加登録」ボタンをクリック
   - キャンセルする場合は「キャンセル」ボタンをクリック

2. **イベントを作成（管理者）**
   - サイドバーから「イベント管理（管理者）」をクリック
   - 「イベントを作成」ボタンをクリック
   - イベント情報を入力して「作成」ボタンをクリック

3. **イベントを削除（管理者）**
   - イベント一覧から削除したいイベントの「削除」ボタンをクリック

### APIエンドポイント

- `GET /api/events` - イベント一覧を取得
- `POST /api/events/register` - イベントに参加登録・キャンセル
- `POST /api/admin/events` - イベントを作成（管理者）
- `DELETE /api/admin/events/{eventId}` - イベントを削除（管理者）

---

## 7. LP面談機能

### 概要
FPエイド昇格の条件の一つである「LP面談完了」を実現するため、FPエイドがメンバーとオンライン面談を行うための予約・管理システムです。

### アクセス権限

#### 7.1 面談予約申請（メンバー）
- **アクセス可能**: 一般会員（`member`）のみ

#### 7.2 面談管理（FPエイド）
- **アクセス可能**: FPエイド（`fp`）のみ

#### 7.3 面談管理（管理者）
- **アクセス可能**: 管理者（`admin`）のみ

### 機能詳細

#### 7.1 メンバー側: LP面談予約申請

**機能**:
- 面談希望日時の入力（**5つ選択**、必須）
- 要望・質問事項の入力（任意）
- 現在の予約状況の表示
- 予約申請の送信

**表示内容**:
- 現在の予約ステータス（未申請 / 申請中 / 予約済み / 完了）
- 申請中の場合: 申請した希望日時（5つ）
- 予約済みの場合: 確定日時、FPエイド名、オンライン面談のURL
- 完了の場合: 完了日時、FPエイドからのメモ

**フロー**:
1. メンバーが希望日時を5つ選択して申請
2. 運営側（管理者）に通知が送信される
3. 運営側が希望日時とFPエイドを選択して面談を確定
4. メンバーとFPエイドの両方に通知が送信される
5. 面談実施（オンライン）
6. FPエイドが面談完了を確認
7. `FPPromotionApplication`の`lpMeetingCompleted`が自動更新

#### 7.2 運営側（管理者）: LP面談管理

**機能**:
- 予約申請一覧の表示（ステータス: REQUESTED）
- 希望日時とFPエイドの選択
- オンライン面談URLの設定
- 面談の確定
- 全面談の一覧表示・管理
- 統計情報の表示

**表示内容**:
- 予約申請一覧（ステータス: REQUESTED）
- 各申請の詳細情報:
  - メンバー名・メールアドレス
  - 希望日時（5つ、選択可能）
  - 要望・質問事項
- 確定済み面談一覧
- 統計情報（申請数、確定数、完了数等）

**操作フロー**:
1. 申請をクリックして詳細を表示
2. 希望日時から1つを選択（ドロップダウン）
3. FPエイドを選択（ドロップダウン）
4. プラットフォームを選択（Zoom、Google Meet、Teams、その他）
5. オンライン面談URLを入力
6. 「面談を確定」ボタンをクリック

#### 7.3 FPエイド側: LP面談管理

**機能**:
- 確定された面談一覧の表示（自分の面談のみ）
- 面談の詳細確認
- 面談完了の確認
- 面談メモの記入

**表示内容**:
- 確定済み面談一覧（ステータス: SCHEDULED）
- 各面談の詳細情報:
  - メンバー名・メールアドレス
  - 面談日時
  - オンライン面談のURL
  - メンバーの要望・質問事項
- 完了済み面談一覧

### 使い方

1. **メンバー: LP面談予約申請**
   - サイドバーから「LP面談予約」をクリック
   - 希望日時を5つ選択（datetime-local入力）
   - 要望・質問事項を入力（任意）
   - 「面談予約を申請」ボタンをクリック

2. **管理者: 面談を確定**
   - サイドバーから「LP面談管理（管理者）」をクリック
   - 申請中の面談一覧から確定したい面談を選択
   - 希望日時から1つを選択
   - FPエイドを選択
   - プラットフォームを選択
   - オンライン面談URLを入力
   - 「面談を確定」ボタンをクリック

3. **FPエイド: 面談完了の確認**
   - サイドバーから「LP面談管理」をクリック
   - 予約済み面談一覧から完了した面談を選択
   - 「完了」ボタンをクリック
   - 面談メモを記入（任意）
   - 「面談完了を確認」ボタンをクリック

### APIエンドポイント

- `POST /api/lp-meetings/request` - 面談予約申請（メンバー）
- `GET /api/lp-meetings/my-meeting?userId={userId}` - 自分の面談状況取得（メンバー）
- `GET /api/admin/lp-meetings` - 面談一覧取得（管理者）
- `POST /api/admin/lp-meetings/{meetingId}/schedule` - 面談を確定（管理者）
- `GET /api/lp-meetings/my-scheduled?fpId={fpId}` - 自分の面談一覧取得（FPエイド）
- `POST /api/lp-meetings/{meetingId}/complete` - 面談完了の確認（FPエイド）

---

## 📝 補足情報

### ロール別アクセス権限一覧

| 機能 | member | fp | manager | admin |
|------|--------|----|---------|-------|
| 紹介管理 | ❌ | ✅ | ✅ | ✅ |
| 契約管理 | ❌ | ✅ | ✅ | ✅ |
| 通知 | ✅ | ✅ | ✅ | ✅ |
| FPエイド昇格申請 | ✅ | ❌ | ❌ | ❌ |
| マネージャー昇格申請 | ❌ | ✅ | ❌ | ❌ |
| LP面談予約 | ✅ | ❌ | ❌ | ❌ |
| LP面談管理 | ❌ | ✅ | ❌ | ❌ |
| LP面談管理（管理者） | ❌ | ❌ | ❌ | ✅ |
| 報酬管理（管理者） | ❌ | ❌ | ❌ | ✅ |
| イベント参加 | ✅ | ✅ | ✅ | ✅ |
| イベント管理（管理者） | ❌ | ❌ | ❌ | ✅ |

### ナビゲーション

各機能へのアクセスは、サイドバーのナビゲーションメニューから行えます：

- **紹介管理**: `/dashboard/referrals`
- **契約管理**: `/dashboard/contracts`
- **通知**: `/dashboard/notifications`
- **昇格管理**: `/dashboard/promotion`
- **LP面談予約**: `/dashboard/lp-meeting/request`（メンバー）
- **LP面談管理**: `/dashboard/lp-meeting/manage`（FPエイド）
- **LP面談管理（管理者）**: `/dashboard/admin/lp-meetings`（管理者）
- **報酬管理（管理者）**: `/dashboard/admin/compensations`
- **イベント**: `/dashboard/events`
- **イベント管理（管理者）**: `/dashboard/admin/events`

### 注意事項

1. **紹介コード**: 各ユーザーには自動的に紹介コードが生成されます。紹介コードはユニークで、変更できません。

2. **昇格申請**: 
   - FPエイド昇格申請には身分証のアップロードが必要です
   - マネージャー昇格申請にはすべての条件を満たす必要があります

3. **報酬管理**: 
   - 報酬は管理者が月次で生成します
   - 報酬の承認・支払いは管理者が行います

4. **LP面談**: 
   - 面談はオンラインのみ対応
   - 希望日時は5つ選択する必要がある
   - 運営側が希望日時とFPエイドを選択して面談を確定
   - 面談完了後、FPエイド昇格の条件が自動的に更新される

5. **イベント**: 
   - 必須イベントは参加が必須です
   - マネージャー限定イベントはマネージャー以上のロールのみ参加可能です

---

## 🔗 関連ドキュメント

- [テストガイド](./TEST-GUIDE.md) - 機能のテスト方法
- [実装サマリー](./IMPLEMENTATION-SUMMARY.md) - 実装の詳細
- [README](./README.md) - プロジェクトの概要

---

**最終更新**: 2024年11月

